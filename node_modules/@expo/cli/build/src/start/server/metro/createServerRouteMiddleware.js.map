{"version":3,"sources":["../../../../../src/start/server/metro/createServerRouteMiddleware.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport type { ProjectConfig } from '@expo/config';\nimport type { MiddlewareSettings } from 'expo-server';\nimport { createRequestHandler } from 'expo-server/adapter/http';\nimport { ImmutableRequest, type RouteInfo } from 'expo-server/private';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { fetchManifest } from './fetchRouterManifest';\nimport { getErrorOverlayHtmlAsync } from './metroErrorInterface';\nimport {\n  warnInvalidWebOutput,\n  warnInvalidMiddlewareOutput,\n  warnInvalidMiddlewareMatcherSettings,\n} from './router';\nimport { CommandError } from '../../../utils/errors';\n\nconst debug = require('debug')('expo:start:server:metro') as typeof console.log;\n\nexport function createRouteHandlerMiddleware(\n  projectRoot: string,\n  options: {\n    appDir: string;\n    routerRoot: string;\n    getStaticPageAsync: (\n      pathname: string,\n      route: RouteInfo<RegExp>,\n      request?: ImmutableRequest\n    ) => Promise<{ content: string }>;\n    bundleApiRoute: (\n      functionFilePath: string\n    ) => Promise<null | Record<string, Function> | Response>;\n    executeLoaderAsync: (\n      route: RouteInfo<RegExp>,\n      request: ImmutableRequest\n    ) => Promise<Response | undefined>;\n    config: ProjectConfig;\n    headers: Record<string, string | string[]>;\n    rsc?: {\n      path: string;\n      handler: {\n        GET: (req: Request) => Promise<Response>;\n        POST: (req: Request) => Promise<Response>;\n      };\n    };\n  } & import('@expo/router-server/build/routes-manifest').Options\n) {\n  if (!resolveFrom.silent(projectRoot, 'expo-router')) {\n    throw new CommandError(\n      `static and server rendering requires the expo-router package to be installed in your project. Either install the expo-router package or change 'web.output' to 'single' in your app.json.`\n    );\n  }\n\n  return createRequestHandler(\n    { build: '', isDevelopment: true },\n    {\n      async getRoutesManifest() {\n        const manifest = await fetchManifest(projectRoot, options);\n        debug('manifest', manifest);\n\n        // TODO(@hassankhan): Invert the conditionals for an early return if no manifest if found\n\n        if (\n          manifest &&\n          options.rsc &&\n          !manifest.apiRoutes.find((route) => route.page.startsWith(options.rsc!.path))\n        ) {\n          // Insert the route before any catch-all routes that might match the RSC path.\n          manifest.apiRoutes.unshift({\n            file: require.resolve('@expo/cli/static/template/[...rsc]+api.ts'),\n            page: `${options.rsc.path}/[...rsc]`,\n            namedRegex: new RegExp(`^${options.rsc.path}(?:/(?<rsc>.+?))?(?:/)?$`),\n            routeKeys: { rsc: 'rsc' },\n          });\n        }\n\n        const { exp } = options.config;\n\n        if (manifest && exp.extra?.router?.unstable_useServerDataLoaders === true) {\n          // In development, set `loader` property on all HTML routes. We can't know which routes\n          // have loaders without bundling via Metro to detect exports. In production, this is\n          // populated by `exportStaticAsync.ts` after bundling.\n          // At runtime, `getLoaderData()` returns a 404 response if no loader exists.\n          for (const route of manifest.htmlRoutes) {\n            route.loader = `_expo/loaders${route.page}.js`;\n          }\n        }\n\n        // NOTE: no app dir if null\n        // TODO: Redirect to 404 page\n        return (\n          manifest ?? {\n            // Support the onboarding screen if there's no manifest\n            htmlRoutes: [\n              {\n                file: 'index.js',\n                page: '/index',\n                routeKeys: {},\n                namedRegex: /^\\/(?:index)?\\/?$/i,\n              },\n            ],\n            apiRoutes: [],\n            notFoundRoutes: [],\n            redirects: [],\n            rewrites: [],\n          }\n        );\n      },\n      async getHtml(request, route) {\n        try {\n          const { exp } = options.config;\n          const isSSREnabled =\n            exp.web?.output === 'server' && exp.extra?.router?.unstable_useServerRendering === true;\n\n          const { content } = await options.getStaticPageAsync(\n            request.url,\n            route,\n            isSSREnabled ? new ImmutableRequest(request) : undefined\n          );\n          return content;\n        } catch (error: any) {\n          // Forward the Metro server response as-is. It won't be pretty, but at least it will be accurate.\n\n          try {\n            return new Response(\n              await getErrorOverlayHtmlAsync({\n                error,\n                projectRoot,\n                routerRoot: options.routerRoot,\n              }),\n              {\n                status: 500,\n                headers: {\n                  'Content-Type': 'text/html',\n                },\n              }\n            );\n          } catch (staticError: any) {\n            debug('Failed to render static error overlay:', staticError);\n            // Fallback error for when Expo Router is misconfigured in the project.\n            return new Response(\n              '<span><h3>Internal Error:</h3><b>Project is not setup correctly for static rendering (check terminal for more info):</b><br/>' +\n                error.message +\n                '<br/><br/>' +\n                staticError.message +\n                '</span>',\n              {\n                status: 500,\n                headers: {\n                  'Content-Type': 'text/html',\n                },\n              }\n            );\n          }\n        }\n      },\n      async handleRouteError(error) {\n        // NOTE(@kitten): ExpoError is currently not exposed by expo-server just yet\n        if (error && typeof error === 'object' && error.name === 'ExpoError') {\n          // TODO(@krystofwoldrich): Can we show code snippet of the handler?\n          // NOTE(@krystofwoldrich): Removing stack since to avoid confusion. The error is not in the server code.\n          delete error.stack;\n        }\n\n        const htmlServerError = await getErrorOverlayHtmlAsync({\n          error,\n          projectRoot,\n          routerRoot: options.routerRoot!,\n        });\n\n        return new Response(htmlServerError, {\n          status: 500,\n          headers: {\n            'Content-Type': 'text/html',\n          },\n        });\n      },\n      async getApiRoute(route) {\n        // We check if RSC is enabled before the warning check, as `web.output` could be set to\n        // `single`\n        if (options.rsc && route.page.startsWith(options.rsc.path)) {\n          return options.rsc.handler;\n        }\n\n        const { exp } = options.config;\n        if (exp.web?.output !== 'server') {\n          warnInvalidWebOutput();\n        }\n\n        // TODO(@kitten): Unify with MetroBundlerDevServer#exportExpoRouterApiRoutesAsync\n        const resolvedFunctionPath = path.isAbsolute(route.file)\n          ? route.file\n          : path.join(options.appDir, route.file);\n        try {\n          debug(`Bundling API route at: ${resolvedFunctionPath}`);\n          return await options.bundleApiRoute(resolvedFunctionPath!);\n        } catch (error: any) {\n          return new Response(\n            'Failed to load API Route: ' + resolvedFunctionPath + '\\n\\n' + error.message,\n            {\n              status: 500,\n              headers: {\n                'Content-Type': 'text/html',\n              },\n            }\n          );\n        }\n      },\n      async getMiddleware(route) {\n        const { exp } = options.config;\n\n        if (!options.unstable_useServerMiddleware) {\n          return {\n            default: () => {\n              throw new CommandError(\n                'Server middleware is not enabled. Add unstable_useServerMiddleware: true to your `expo-router` plugin config.'\n              );\n            },\n          };\n        }\n\n        if (exp.web?.output !== 'server') {\n          warnInvalidMiddlewareOutput();\n          return {\n            default: () => {\n              console.warn(\n                'Server middleware is only supported when web.output is set to \"server\" in your app config'\n              );\n            },\n          };\n        }\n\n        // TODO(@kitten): Unify with MetroBundlerDevServer#exportMiddlewareAsync\n        const resolvedFunctionPath = path.isAbsolute(route.file)\n          ? route.file\n          : path.join(options.appDir, route.file);\n        try {\n          debug(`Bundling middleware at: ${resolvedFunctionPath}`);\n          const middlewareModule = (await options.bundleApiRoute(resolvedFunctionPath!)) as any;\n\n          if ((middlewareModule.unstable_settings as MiddlewareSettings)?.matcher) {\n            warnInvalidMiddlewareMatcherSettings(middlewareModule.unstable_settings?.matcher);\n          }\n\n          return middlewareModule;\n        } catch (error: any) {\n          return new Response(\n            'Failed to load middleware: ' + resolvedFunctionPath + '\\n\\n' + error.message,\n            {\n              status: 500,\n              headers: {\n                'Content-Type': 'text/html',\n              },\n            }\n          );\n        }\n      },\n      async getLoaderData(request, route) {\n        const response = await options.executeLoaderAsync(route, new ImmutableRequest(request));\n        return response ?? new Response(null, { status: 404 });\n      },\n    }\n  );\n}\n"],"names":["createRouteHandlerMiddleware","debug","require","projectRoot","options","resolveFrom","silent","CommandError","createRequestHandler","build","isDevelopment","getRoutesManifest","exp","manifest","fetchManifest","rsc","apiRoutes","find","route","page","startsWith","path","unshift","file","resolve","namedRegex","RegExp","routeKeys","config","extra","router","unstable_useServerDataLoaders","htmlRoutes","loader","notFoundRoutes","redirects","rewrites","getHtml","request","isSSREnabled","web","output","unstable_useServerRendering","content","getStaticPageAsync","url","ImmutableRequest","undefined","error","Response","getErrorOverlayHtmlAsync","routerRoot","status","headers","staticError","message","handleRouteError","name","stack","htmlServerError","getApiRoute","handler","warnInvalidWebOutput","resolvedFunctionPath","isAbsolute","join","appDir","bundleApiRoute","getMiddleware","unstable_useServerMiddleware","default","warnInvalidMiddlewareOutput","console","warn","middlewareModule","unstable_settings","matcher","warnInvalidMiddlewareMatcherSettings","getLoaderData","response","executeLoaderAsync"],"mappings":"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"}