{"version":3,"sources":["../../../../../src/start/server/metro/MetroBundlerDevServer.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { ExpoConfig, getConfig } from '@expo/config';\nimport { getMetroServerRoot } from '@expo/config/paths';\nimport baseJSBundle from '@expo/metro/metro/DeltaBundler/Serializers/baseJSBundle';\nimport {\n  sourceMapGeneratorNonBlocking,\n  type SourceMapGeneratorOptions,\n} from '@expo/metro/metro/DeltaBundler/Serializers/sourceMapGenerator';\nimport type {\n  Module,\n  DeltaResult,\n  TransformInputOptions,\n} from '@expo/metro/metro/DeltaBundler/types';\nimport type {\n  default as MetroHmrServer,\n  Client as MetroHmrClient,\n} from '@expo/metro/metro/HmrServer';\nimport type { GraphRevision } from '@expo/metro/metro/IncrementalBundler';\nimport type MetroServer from '@expo/metro/metro/Server';\nimport bundleToString from '@expo/metro/metro/lib/bundleToString';\nimport getGraphId from '@expo/metro/metro/lib/getGraphId';\nimport type { TransformProfile } from '@expo/metro/metro-babel-transformer';\nimport type { CustomResolverOptions } from '@expo/metro/metro-resolver';\nimport { SerialAsset } from '@expo/metro-config/build/serializer/serializerAssets';\nimport type { GetStaticContentOptions } from '@expo/router-server/build/static/renderStaticContent';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport type { RouteNode } from 'expo-router/build/Route';\nimport {\n  type RouteInfo,\n  type RoutesManifest,\n  type ImmutableRequest,\n  resolveLoaderContextKey,\n} from 'expo-server/private';\nimport https from 'https';\nimport path from 'path';\n\nimport {\n  createServerComponentsMiddleware,\n  fileURLToFilePath,\n} from './createServerComponentsMiddleware';\nimport { createRouteHandlerMiddleware } from './createServerRouteMiddleware';\nimport { fetchManifest, inflateManifest } from './fetchRouterManifest';\nimport { instantiateMetroAsync } from './instantiateMetro';\nimport {\n  attachImportStackToRootMessage,\n  dropStackIfContainsCodeFrame,\n  getErrorOverlayHtmlAsync,\n  IS_METRO_BUNDLE_ERROR_SYMBOL,\n} from './metroErrorInterface';\nimport { metroWatchTypeScriptFiles } from './metroWatchTypeScriptFiles';\nimport {\n  getRouterDirectoryModuleIdWithManifest,\n  hasWarnedAboutApiRoutes,\n  isApiRouteConvention,\n  warnInvalidWebOutput,\n} from './router';\nimport { serializeHtmlWithAssets } from './serializeHtml';\nimport { observeAnyFileChanges, observeFileChanges } from './waitForMetroToObserveTypeScriptFile';\nimport { events } from '../../../events';\nimport type {\n  BundleAssetWithFileHashes,\n  ExportAssetDescriptor,\n  ExportAssetMap,\n} from '../../../export/saveAssets';\nimport { Log } from '../../../log';\nimport { env } from '../../../utils/env';\nimport { CommandError } from '../../../utils/errors';\nimport { toPosixPath } from '../../../utils/filePath';\nimport { getEnvFiles, reloadEnvFiles } from '../../../utils/nodeEnv';\nimport { getFreePortAsync } from '../../../utils/port';\nimport { BundlerDevServer, BundlerStartOptions, DevServerInstance } from '../BundlerDevServer';\nimport {\n  cachedSourceMaps,\n  evalMetroAndWrapFunctions,\n  evalMetroNoHandling,\n} from '../getStaticRenderFunctions';\nimport {\n  fromRuntimeManifestRoute,\n  fromServerManifestRoute,\n  type ResolvedLoaderRoute,\n} from './resolveLoader';\nimport { ContextModuleSourceMapsMiddleware } from '../middleware/ContextModuleSourceMapsMiddleware';\nimport { CreateFileMiddleware } from '../middleware/CreateFileMiddleware';\nimport { DevToolsPluginMiddleware } from '../middleware/DevToolsPluginMiddleware';\nimport { createDomComponentsMiddleware } from '../middleware/DomComponentsMiddleware';\nimport { FaviconMiddleware } from '../middleware/FaviconMiddleware';\nimport { HistoryFallbackMiddleware } from '../middleware/HistoryFallbackMiddleware';\nimport { InterstitialPageMiddleware } from '../middleware/InterstitialPageMiddleware';\nimport { resolveMainModuleName } from '../middleware/ManifestMiddleware';\nimport { RuntimeRedirectMiddleware } from '../middleware/RuntimeRedirectMiddleware';\nimport { ServeStaticMiddleware } from '../middleware/ServeStaticMiddleware';\nimport {\n  convertPathToModuleSpecifier,\n  createBundleUrlPath,\n  ExpoMetroOptions,\n  createBundleOsPath,\n  getAsyncRoutesFromExpoConfig,\n  getBaseUrlFromExpoConfig,\n  getMetroDirectBundleOptions,\n} from '../middleware/metroOptions';\nimport { prependMiddleware } from '../middleware/mutations';\nimport { ServerNext, ServerRequest, ServerResponse } from '../middleware/server.types';\nimport { startTypescriptTypeGenerationAsync } from '../type-generation/startTypescriptTypeGeneration';\n\nexport type ExpoRouterRuntimeManifest = Awaited<\n  ReturnType<typeof import('@expo/router-server/build/static/renderStaticContent').getManifest>\n>;\n\ntype SSRLoadModuleFunc = <T extends Record<string, any>>(\n  filePath: string | null,\n  specificOptions?: Partial<ExpoMetroOptions>,\n  extras?: { hot?: boolean }\n) => Promise<T>;\n\ninterface BundleDirectResult {\n  numModifiedFiles: number;\n  lastModifiedDate: Date;\n  nextRevId: string;\n  bundle: string;\n  map: string;\n  /** Defined if the output is multi-bundle. */\n  artifacts?: SerialAsset[];\n  assets?: readonly BundleAssetWithFileHashes[];\n}\n\ninterface MetroModuleContentsResult extends BundleDirectResult {\n  filename: string;\n}\n\ninterface SSRModuleContentsResult extends Omit<BundleDirectResult, 'bundle'> {\n  filename: string;\n  src: string;\n  map: string;\n}\n\n// TODO(@kitten): We access this here to run server-side code bundled by metro\n// It's not isolated into a worker thread yet\n// Check `metro-require/require.ts` for how this function is defined\ndeclare namespace globalThis {\n  const __c: (() => void) | undefined;\n  let __expo_rsc_inject_module: (params: { code: string; id: string }) => void | undefined;\n}\n\nconst debug = require('debug')('expo:start:server:metro') as typeof console.log;\n\n/** Default port to use for apps running in Expo Go. */\nconst EXPO_GO_METRO_PORT = 8081;\n\n/** Default port to use for apps that run in standard React Native projects or Expo Dev Clients. */\nconst DEV_CLIENT_METRO_PORT = 8081;\n\n// prettier-ignore\nexport const event = events('devserver', (t) => [\n  t.event<'start', {\n    mode: 'production' | 'development';\n    web: boolean;\n    baseUrl: string;\n    asyncRoutes: boolean;\n    routerRoot: string;\n    serverComponents: boolean;\n    serverActions: boolean;\n    serverRendering: boolean;\n    apiRoutes: boolean;\n    exporting: boolean;\n  }>(),\n]);\n\nexport class MetroBundlerDevServer extends BundlerDevServer {\n  private metro: MetroServer | null = null;\n  private hmrServer: MetroHmrServer<MetroHmrClient> | null = null;\n  private ssrHmrClients: Map<string, MetroHmrClient> = new Map();\n  isReactServerComponentsEnabled?: boolean;\n  isReactServerRoutesEnabled?: boolean;\n\n  get name(): string {\n    return 'metro';\n  }\n\n  async resolvePortAsync(options: Partial<BundlerStartOptions> = {}): Promise<number> {\n    const port =\n      // If the manually defined port is busy then an error should be thrown...\n      options.port ??\n      // Otherwise use the default port based on the runtime target.\n      (options.devClient\n        ? // Don't check if the port is busy if we're using the dev client since most clients are hardcoded to 8081.\n          Number(process.env.RCT_METRO_PORT) || DEV_CLIENT_METRO_PORT\n        : // Otherwise (running in Expo Go) use a free port that falls back on the classic 8081 port.\n          await getFreePortAsync(EXPO_GO_METRO_PORT));\n\n    return port;\n  }\n\n  private async exportServerRouteAsync({\n    contents,\n    artifactFilename,\n    files,\n    includeSourceMaps,\n    descriptor,\n  }: {\n    contents: { src: string; map?: any } | null | undefined;\n    artifactFilename: string;\n    files: ExportAssetMap;\n    includeSourceMaps?: boolean;\n    routeId?: string;\n    descriptor: Partial<ExportAssetDescriptor>;\n  }) {\n    if (!contents) return;\n\n    let src = contents.src;\n    if (includeSourceMaps && contents.map) {\n      // TODO(kitten): Merge the source map transformer in the future\n      // https://github.com/expo/expo/blob/0dffdb15/packages/%40expo/metro-config/src/serializer/serializeChunks.ts#L422-L439\n      // Alternatively, check whether `sourcesRoot` helps here\n      const artifactBasename = encodeURIComponent(path.basename(artifactFilename) + '.map');\n      src = src.replace(/\\/\\/# sourceMappingURL=.*/g, `//# sourceMappingURL=${artifactBasename}`);\n      const parsedMap = typeof contents.map === 'string' ? JSON.parse(contents.map) : contents.map;\n      const mapData: any = {\n        ...descriptor,\n        contents: JSON.stringify({\n          version: parsedMap.version,\n          sources: parsedMap.sources.map((source: string) => {\n            source =\n              typeof source === 'string' && source.startsWith(this.projectRoot)\n                ? path.relative(this.projectRoot, source)\n                : source;\n            return convertPathToModuleSpecifier(source);\n          }),\n          sourcesContent: new Array(parsedMap.sources.length).fill(null),\n          names: parsedMap.names,\n          mappings: parsedMap.mappings,\n        }),\n        targetDomain: 'server',\n      };\n      files.set(artifactFilename + '.map', mapData);\n    }\n    const fileData: ExportAssetDescriptor = {\n      ...descriptor,\n      contents: src,\n      targetDomain: 'server',\n    };\n    files.set(artifactFilename, fileData);\n  }\n\n  private async exportMiddlewareAsync({\n    manifest,\n    appDir,\n    outputDir,\n    files,\n    platform,\n    includeSourceMaps,\n  }: {\n    manifest: RoutesManifest;\n    appDir: string;\n    outputDir: string;\n    files: ExportAssetMap;\n    platform: string;\n    includeSourceMaps?: boolean;\n  }) {\n    if (!manifest.middleware) return;\n\n    const middlewareFilePath = path.isAbsolute(manifest.middleware.file)\n      ? manifest.middleware.file\n      : path.join(appDir, manifest.middleware.file);\n    const contents = await this.bundleApiRoute(middlewareFilePath, { platform });\n    const artifactFilename = convertPathToModuleSpecifier(\n      path.join(outputDir, path.relative(appDir, middlewareFilePath.replace(/\\.[tj]sx?$/, '.js')))\n    );\n\n    await this.exportServerRouteAsync({\n      contents,\n      artifactFilename,\n      files,\n      includeSourceMaps,\n      descriptor: {\n        middlewareId: '/middleware',\n      },\n    });\n\n    // Remap the middleware file to represent the output file.\n    manifest.middleware.file = artifactFilename;\n  }\n\n  async exportExpoRouterApiRoutesAsync({\n    includeSourceMaps,\n    outputDir,\n    prerenderManifest,\n    platform,\n  }: {\n    includeSourceMaps?: boolean;\n    outputDir: string;\n    // This does not contain the API routes info.\n    prerenderManifest: RoutesManifest<string>;\n    platform: string;\n  }): Promise<{ files: ExportAssetMap; manifest: RoutesManifest<string> }> {\n    const { routerRoot } = this.instanceMetroOptions;\n    assert(\n      routerRoot != null,\n      'The server must be started before calling exportExpoRouterApiRoutesAsync.'\n    );\n\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const manifest = await this.getExpoRouterRoutesManifestAsync({ appDir });\n\n    const files: ExportAssetMap = new Map();\n\n    // Inject RSC middleware.\n    const rscPath = '/_flight/[...rsc]';\n\n    if (\n      this.isReactServerComponentsEnabled &&\n      // If the RSC route is not already in the manifest, add it.\n      !manifest.apiRoutes.find((route) => route.page.startsWith('/_flight/'))\n    ) {\n      debug('Adding RSC route to the manifest:', rscPath);\n      // NOTE: This might need to be sorted to the correct spot in the future.\n      manifest.apiRoutes.push({\n        // TODO(@kitten): This isn't great, we shouldn't be needing to rely on files like this\n        // It might even be better to make templating strings since that'd be type-checked, but currently,\n        // we rely on this being an entrypoint for Metro\n        file: require.resolve('@expo/cli/static/template/[...rsc]+api.ts'),\n        page: rscPath,\n        namedRegex: '^/_flight(?:/(?<rsc>.+?))?(?:/)?$',\n        routeKeys: { rsc: 'rsc' },\n      });\n    }\n\n    await this.exportMiddlewareAsync({\n      manifest,\n      appDir,\n      outputDir,\n      files,\n      platform,\n      includeSourceMaps,\n    });\n\n    for (const route of manifest.apiRoutes) {\n      const filepath = path.isAbsolute(route.file) ? route.file : path.join(appDir, route.file);\n      const contents = await this.bundleApiRoute(filepath, { platform });\n\n      const artifactFilename =\n        route.page === rscPath\n          ? // HACK: Add RSC renderer to the output...\n            convertPathToModuleSpecifier(path.join(outputDir, '.' + rscPath + '.js'))\n          : convertPathToModuleSpecifier(\n              path.join(outputDir, path.relative(appDir, filepath.replace(/\\.[tj]sx?$/, '.js')))\n            );\n\n      await this.exportServerRouteAsync({\n        contents,\n        artifactFilename,\n        files,\n        includeSourceMaps,\n        descriptor: {\n          apiRouteId: route.page,\n        },\n      });\n      // Remap the manifest files to represent the output files.\n      route.file = artifactFilename;\n    }\n\n    return {\n      manifest: {\n        ...manifest,\n        htmlRoutes: prerenderManifest.htmlRoutes,\n      },\n      files,\n    };\n  }\n\n  /**\n   * Bundle render module for use in SSR\n   */\n  async exportExpoRouterRenderModuleAsync({\n    files,\n    includeSourceMaps,\n    platform = 'web',\n  }: {\n    files: ExportAssetMap;\n    includeSourceMaps?: boolean;\n    platform?: string;\n  }) {\n    const renderModule = await this.ssrLoadModuleContents(\n      require.resolve('@expo/router-server/node/render.js'),\n      {\n        environment: 'node',\n        platform,\n      }\n    );\n\n    await this.exportServerRouteAsync({\n      contents: renderModule,\n      artifactFilename: '_expo/server/render.js',\n      files,\n      includeSourceMaps,\n      descriptor: {\n        // ssrRenderModule: true,\n        targetDomain: 'server',\n      },\n    });\n\n    return files;\n  }\n\n  /**\n   * Export loader bundles as standalone JS files for SSR data loading.\n   *\n   * Each loader bundle contains only the `loader` export from the route file,\n   * with all other exports (default, named) stripped out by the Babel plugin.\n   * This keeps loader bundles small for efficient server-side execution.\n   */\n  async exportExpoRouterLoadersAsync({\n    platform,\n    entryPoints,\n    files,\n    outputDir,\n    includeSourceMaps,\n  }: {\n    platform: string;\n    entryPoints: { file: string; page: string }[];\n    files: ExportAssetMap;\n    outputDir: string;\n    includeSourceMaps: boolean;\n  }): Promise<void> {\n    // NOTE(@hassankhan): Should we parallelize loader bundling?\n    for (const entry of entryPoints) {\n      const contents = await this.bundleLoader(entry.file, { platform });\n      const pagePath = entry.page.startsWith('/') ? entry.page.slice(1) : entry.page;\n      const artifactFilename = convertPathToModuleSpecifier(path.join(outputDir, pagePath + '.js'));\n\n      await this.exportServerRouteAsync({\n        contents,\n        artifactFilename,\n        files,\n        includeSourceMaps,\n        descriptor: {\n          loaderId: entry.page,\n        },\n      });\n    }\n  }\n\n  async getExpoRouterRoutesManifestAsync({ appDir }: { appDir: string }) {\n    // getBuiltTimeServerManifest\n    const { exp } = getConfig(this.projectRoot);\n    const manifest = await fetchManifest(this.projectRoot, {\n      ...exp.extra?.router,\n      preserveRedirectAndRewrites: true,\n      asJson: true,\n      appDir,\n    });\n\n    if (!manifest) {\n      throw new CommandError(\n        'EXPO_ROUTER_SERVER_MANIFEST',\n        'Unexpected error: server manifest could not be fetched.'\n      );\n    }\n\n    return manifest;\n  }\n\n  async getServerManifestAsync(): Promise<{\n    serverManifest: RoutesManifest<string>;\n    htmlManifest: ExpoRouterRuntimeManifest;\n  }> {\n    const { exp } = getConfig(this.projectRoot);\n    // NOTE: This could probably be folded back into `renderStaticContent` when expo-asset and font support RSC.\n    const { getBuildTimeServerManifestAsync, getManifest } = await this.ssrLoadModule<\n      typeof import('@expo/router-server/build/static/getServerManifest')\n    >(require.resolve('@expo/router-server/build/static/getServerManifest.js'), {\n      // Only use react-server environment when the routes are using react-server rendering by default.\n      environment: this.isReactServerRoutesEnabled ? 'react-server' : 'node',\n    });\n\n    return {\n      serverManifest: await getBuildTimeServerManifestAsync({ ...exp.extra?.router }),\n      htmlManifest: await getManifest({ ...exp.extra?.router }),\n    };\n  }\n\n  /**\n   * This function is invoked when exporting via `expo export`\n   */\n  async getStaticRenderFunctionAsync(): Promise<{\n    serverManifest: RoutesManifest<string>;\n    manifest: ExpoRouterRuntimeManifest;\n    renderAsync: (\n      path: string,\n      route: RouteNode,\n      opts?: GetStaticContentOptions\n    ) => Promise<string>;\n    executeLoaderAsync: (path: string, route: RouteNode) => Promise<Response | undefined>;\n  }> {\n    const { routerRoot } = this.instanceMetroOptions;\n    assert(\n      routerRoot != null,\n      'The server must be started before calling getStaticRenderFunctionAsync.'\n    );\n\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const url = this.getDevServerUrlOrAssert();\n\n    const { getStaticContent, getManifest, getBuildTimeServerManifestAsync } =\n      await this.ssrLoadModule<\n        typeof import('@expo/router-server/build/static/renderStaticContent')\n      >(require.resolve('@expo/router-server/node/render.js'), {\n        // This must always use the legacy rendering resolution (no `react-server`) because it leverages\n        // the previous React SSG utilities which aren't available in React 19.\n        environment: 'node',\n      });\n\n    const { exp } = getConfig(this.projectRoot);\n    const useServerRendering = exp.extra?.router?.unstable_useServerRendering ?? false;\n    const isExportingWithSSR =\n      exp.web?.output === 'server' && useServerRendering && !this.isReactServerComponentsEnabled;\n\n    const serverManifest = await getBuildTimeServerManifestAsync({\n      ...exp.extra?.router,\n      // Skip static params expansion in SSR mode, routes are matched at runtime instead\n      skipStaticParams: isExportingWithSSR,\n    });\n\n    return {\n      serverManifest,\n      // Get routes from Expo Router.\n      manifest: await getManifest({ preserveApiRoutes: false, ...exp.extra?.router }),\n      // Get route generating function\n      renderAsync: async (path, route, opts?) => {\n        const location = new URL(path, url);\n        return await getStaticContent(location, opts);\n      },\n      executeLoaderAsync: async (path, route) => {\n        const location = new URL(path, url);\n\n        const resolvedLoaderRoute = fromRuntimeManifestRoute(location.pathname, route, {\n          serverManifest: inflateManifest(serverManifest),\n          appDir,\n        });\n\n        if (!resolvedLoaderRoute) {\n          return undefined;\n        }\n\n        return this.executeServerDataLoaderAsync(location, resolvedLoaderRoute);\n      },\n    };\n  }\n\n  async getStaticResourcesAsync({\n    includeSourceMaps,\n    mainModuleName,\n    clientBoundaries = this.instanceMetroOptions.clientBoundaries ?? [],\n    platform = 'web',\n  }: {\n    includeSourceMaps?: boolean;\n    mainModuleName?: string;\n    clientBoundaries?: string[];\n    platform?: string;\n  } = {}) {\n    const { mode, minify, isExporting, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        routerRoot != null &&\n        reactCompiler != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticResourcesAsync.'\n    );\n\n    const resolvedMainModuleName =\n      mainModuleName ?? './' + resolveMainModuleName(this.projectRoot, { platform });\n    return await this.metroImportAsArtifactsAsync(resolvedMainModuleName, {\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      minify,\n      environment: 'client',\n      serializerIncludeMaps: includeSourceMaps,\n      mainModuleName: resolvedMainModuleName,\n      lazy: !env.EXPO_NO_METRO_LAZY,\n      asyncRoutes,\n      baseUrl,\n      isExporting,\n      routerRoot,\n      clientBoundaries,\n      reactCompiler,\n      bytecode: false,\n    });\n  }\n\n  /**\n   * This function is invoked when running in development via `expo start`\n   */\n  private async getStaticPageAsync(\n    pathname: string,\n    route: RouteInfo<RegExp>,\n    request?: ImmutableRequest\n  ) {\n    const { exp } = getConfig(this.projectRoot);\n    const { mode, isExporting, clientBoundaries, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        reactCompiler != null &&\n        routerRoot != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticPageAsync.'\n    );\n    const platform = 'web';\n\n    const devBundleUrlPathname = createBundleUrlPath({\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      environment: 'client',\n      reactCompiler,\n      mainModuleName: resolveMainModuleName(this.projectRoot, { platform }),\n      lazy: !env.EXPO_NO_METRO_LAZY,\n      baseUrl,\n      isExporting,\n      asyncRoutes,\n      routerRoot,\n      clientBoundaries,\n      bytecode: false,\n    });\n\n    const bundleStaticHtml = async (): Promise<string> => {\n      const { getStaticContent } = await this.ssrLoadModule<\n        typeof import('@expo/router-server/build/static/renderStaticContent')\n      >(require.resolve('@expo/router-server/node/render.js'), {\n        // This must always use the legacy rendering resolution (no `react-server`) because it leverages\n        // the previous React SSG utilities which aren't available in React 19.\n        environment: 'node',\n        minify: false,\n        isExporting,\n        platform,\n      });\n\n      const location = new URL(pathname, this.getDevServerUrlOrAssert());\n\n      const useServerDataLoaders = exp.extra?.router?.unstable_useServerDataLoaders;\n      if (!useServerDataLoaders) {\n        return await getStaticContent(location);\n      }\n\n      const resolvedLoaderRoute = fromServerManifestRoute(location.pathname, route);\n      if (!resolvedLoaderRoute) {\n        return await getStaticContent(location);\n      }\n\n      const loaderResult = await this.executeServerDataLoaderAsync(\n        location,\n        resolvedLoaderRoute,\n        request\n      );\n      if (!loaderResult) {\n        return await getStaticContent(location);\n      }\n\n      const loaderData = await loaderResult.json();\n      const resolvedLoaderKey = resolveLoaderContextKey(\n        resolvedLoaderRoute.contextKey,\n        resolvedLoaderRoute.params\n      );\n      return await getStaticContent(location, {\n        loader: { data: loaderData, key: resolvedLoaderKey },\n      });\n    };\n\n    const [{ artifacts: resources }, staticHtml] = await Promise.all([\n      this.getStaticResourcesAsync({\n        clientBoundaries: [],\n      }),\n      bundleStaticHtml(),\n    ]);\n    const content = serializeHtmlWithAssets({\n      isExporting,\n      resources,\n      template: staticHtml,\n      devBundleUrl: devBundleUrlPathname,\n      baseUrl,\n      hydrate: env.EXPO_WEB_DEV_HYDRATE,\n    });\n    return {\n      content,\n      resources,\n    };\n  }\n\n  // Set when the server is started.\n  private instanceMetroOptions: Partial<ExpoMetroOptions> = {};\n\n  private ssrLoadModule: SSRLoadModuleFunc = async (\n    filePath,\n    specificOptions = {},\n    extras = {}\n  ) => {\n    // NOTE(@kitten): We don't properly initialize the server-side modules\n    // Instead, we first load an entrypoint with an empty bundle to initialize the runtime instead\n    // See: ./createServerComponentsMiddleware.ts\n    const getEmptyModulePath = () => {\n      assert(this.metro, 'Metro server must be running to load SSR modules.');\n      return this.metro._config.resolver.emptyModulePath;\n    };\n\n    const res = await this.ssrLoadModuleContents(filePath ?? getEmptyModulePath(), specificOptions);\n\n    if (\n      // TODO: hot should be a callback function for invalidating the related SSR module.\n      extras.hot &&\n      this.instanceMetroOptions.isExporting !== true\n    ) {\n      // Register SSR HMR\n      const serverRoot = getMetroServerRoot(this.projectRoot);\n      const relativePath = path.relative(serverRoot, res.filename);\n      const url = new URL(relativePath, this.getDevServerUrlOrAssert());\n      this.setupHmr(url);\n    }\n\n    return evalMetroAndWrapFunctions(\n      this.projectRoot,\n      res.src,\n      res.filename,\n      specificOptions.isExporting ?? this.instanceMetroOptions.isExporting!\n    );\n  };\n\n  private async metroImportAsArtifactsAsync(\n    filePath: string,\n    specificOptions: Partial<Omit<ExpoMetroOptions, 'serializerOutput'>> = {}\n  ) {\n    const results = await this.ssrLoadModuleContents(filePath, {\n      serializerOutput: 'static',\n      ...specificOptions,\n    });\n\n    // NOTE: This could potentially need more validation in the future.\n    if (results.artifacts && results.assets) {\n      return {\n        artifacts: results.artifacts,\n        assets: results.assets,\n        src: results.src,\n        filename: results.filename,\n        map: results.map,\n      };\n    }\n    throw new CommandError('Invalid bundler results: ' + results);\n  }\n\n  private async metroLoadModuleContents(\n    filePath: string,\n    specificOptions: ExpoMetroOptions,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<MetroModuleContentsResult> {\n    const { baseUrl } = this.instanceMetroOptions;\n    assert(baseUrl != null, 'The server must be started before calling metroLoadModuleContents.');\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      // mainModuleName: filePath,\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      // bytecode: false,\n      // Bundle in Node.js mode for SSR.\n      environment: 'node',\n      // platform: 'web',\n      // mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n      baseUrl,\n      // routerRoot,\n      // isExporting,\n      ...specificOptions,\n    };\n\n    const expoBundleOptions = getMetroDirectBundleOptions(opts);\n\n    const resolverOptions = {\n      customResolverOptions: expoBundleOptions.customResolverOptions ?? {},\n      dev: expoBundleOptions.dev ?? true,\n    };\n\n    const transformOptions: TransformInputOptions = {\n      dev: expoBundleOptions.dev ?? true,\n      minify: expoBundleOptions.minify ?? false,\n      type: 'module',\n      unstable_transformProfile:\n        extraOptions.unstable_transformProfile ??\n        expoBundleOptions.unstable_transformProfile ??\n        'default',\n      customTransformOptions: expoBundleOptions.customTransformOptions ?? Object.create(null),\n      platform: expoBundleOptions.platform ?? 'web',\n    };\n\n    const resolvedEntryFilePath = await this.resolveRelativePathAsync(filePath, {\n      resolverOptions,\n      transformOptions,\n    });\n\n    const filename = createBundleOsPath({\n      ...opts,\n      mainModuleName: resolvedEntryFilePath,\n    });\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    // TODO(@kitten): We've flagged this way of \"direct transpilation\" for replacement, since it's hard to maintain\n    // It's possible that the intention here was to do something like what `exportEmbedAsync` is doing (using Server.DEFAULT_BUNDLE_OPTIONS)\n    // That's why the defaults were added to match types. It's unclear though if that was correct\n    // Maybe the `Server.DEFAULT_BUNDLE_OPTIONS` logic should be hoisted into `getMetroDirectBundleOptions`?\n    const results = await this._bundleDirectAsync(resolvedEntryFilePath, {\n      graphOptions: {\n        lazy: expoBundleOptions.lazy ?? false,\n        shallow: expoBundleOptions.shallow ?? false,\n      },\n      resolverOptions,\n      serializerOptions: {\n        ...expoBundleOptions.serializerOptions,\n        inlineSourceMap: expoBundleOptions.inlineSourceMap ?? false,\n        modulesOnly: expoBundleOptions.modulesOnly ?? false,\n        runModule: expoBundleOptions.runModule ?? true,\n        sourceUrl: expoBundleOptions.sourceUrl!,\n        sourceMapUrl: extraOptions.sourceMapUrl ?? expoBundleOptions.sourceMapUrl!,\n      },\n      transformOptions,\n    });\n\n    return {\n      ...results,\n      filename,\n    };\n  }\n\n  private async ssrLoadModuleContents(\n    filePath: string,\n    specificOptions: Partial<ExpoMetroOptions> = {}\n  ): Promise<SSRModuleContentsResult> {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling ssrLoadModuleContents.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      mainModuleName: convertPathToModuleSpecifier(filePath),\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      bytecode: false,\n      // Bundle in Node.js mode for SSR unless RSC is enabled.\n      environment: this.isReactServerComponentsEnabled ? 'react-server' : 'node',\n      platform: 'web',\n      mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n\n      // Mostly disable compiler in SSR bundles.\n      reactCompiler: false,\n      baseUrl,\n      routerRoot,\n      isExporting,\n\n      ...specificOptions,\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    const { filename, bundle, map, ...rest } = await this.metroLoadModuleContents(filePath, opts);\n    const scriptContents = wrapBundle(bundle);\n\n    if (map) {\n      debug('Registering SSR source map for:', filename);\n      cachedSourceMaps.set(filename, { url: this.projectRoot, map });\n    } else {\n      debug('No SSR source map found for:', filename);\n    }\n\n    return {\n      ...rest,\n      src: scriptContents,\n      filename,\n      map,\n    };\n  }\n\n  async nativeExportBundleAsync(\n    exp: ExpoConfig,\n    options: Omit<\n      ExpoMetroOptions,\n      'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    files: ExportAssetMap,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{\n    artifacts: SerialAsset[];\n    assets: readonly BundleAssetWithFileHashes[];\n    files?: ExportAssetMap;\n  }> {\n    if (this.isReactServerComponentsEnabled) {\n      return this.singlePageReactServerComponentExportAsync(exp, options, files, extraOptions);\n    }\n\n    return this.legacySinglePageExportBundleAsync(options, extraOptions);\n  }\n\n  private async singlePageReactServerComponentExportAsync(\n    exp: ExpoConfig,\n    options: Omit<\n      ExpoMetroOptions,\n      'baseUrl' | 'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    files: ExportAssetMap,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{\n    artifacts: SerialAsset[];\n    assets: readonly BundleAssetWithFileHashes[];\n    files: ExportAssetMap;\n  }> {\n    const getReactServerReferences = (artifacts: SerialAsset[]): string[] => {\n      // Get the React server action boundaries from the client bundle.\n      return unique(\n        artifacts\n          .filter((a) => a.type === 'js')\n          .map((artifact) =>\n            artifact.metadata.reactServerReferences?.map((ref) => fileURLToFilePath(ref))\n          )\n          // TODO: Segment by module for splitting.\n          .flat()\n          .filter(Boolean) as string[]\n      );\n    };\n\n    // NOTE(EvanBacon): This will not support any code elimination since it's a static pass.\n    let {\n      reactClientReferences: clientBoundaries,\n      reactServerReferences: serverActionReferencesInServer,\n      cssModules,\n    } = await this.rscRenderer!.getExpoRouterClientReferencesAsync(\n      {\n        platform: options.platform,\n        domRoot: options.domRoot,\n      },\n      files\n    );\n\n    // TODO: The output keys should be in production format or use a lookup manifest.\n\n    const processClientBoundaries = async (\n      reactServerReferences: string[]\n    ): Promise<{\n      artifacts: SerialAsset[];\n      assets: readonly BundleAssetWithFileHashes[];\n    }> => {\n      debug('Evaluated client boundaries:', clientBoundaries);\n\n      // Run metro bundler and create the JS bundles/source maps.\n      const bundle = await this.legacySinglePageExportBundleAsync(\n        {\n          ...options,\n          clientBoundaries,\n        },\n        extraOptions\n      );\n\n      // Get the React server action boundaries from the client bundle.\n      const newReactServerReferences = getReactServerReferences(bundle.artifacts);\n\n      if (!newReactServerReferences) {\n        // Possible issue with babel plugin / metro-config.\n        throw new Error(\n          'Static server action references were not returned from the Metro client bundle'\n        );\n      }\n      debug('React server action boundaries from client:', newReactServerReferences);\n\n      const allKnownReactServerReferences = unique([\n        ...reactServerReferences,\n        ...newReactServerReferences,\n      ]);\n\n      // When we export the server actions that were imported from the client, we may need to re-bundle the client with the new client boundaries.\n      const { clientBoundaries: nestedClientBoundaries } =\n        await this.rscRenderer!.exportServerActionsAsync(\n          {\n            platform: options.platform,\n            domRoot: options.domRoot,\n            entryPoints: allKnownReactServerReferences,\n          },\n          files\n        );\n\n      // TODO: Check against all modules in the initial client bundles.\n      const hasUniqueClientBoundaries = nestedClientBoundaries.some(\n        (boundary) => !clientBoundaries.includes(boundary)\n      );\n\n      if (!hasUniqueClientBoundaries) {\n        return bundle;\n      }\n\n      debug('Re-bundling client with nested client boundaries:', nestedClientBoundaries);\n\n      clientBoundaries = unique(clientBoundaries.concat(nestedClientBoundaries));\n\n      // Re-bundle the client with the new client boundaries that only exist in server actions that were imported from the client.\n      // Run metro bundler and create the JS bundles/source maps.\n      return processClientBoundaries(allKnownReactServerReferences);\n    };\n\n    const bundle = await processClientBoundaries(serverActionReferencesInServer);\n\n    // Inject the global CSS that was imported during the server render.\n    bundle.artifacts.push(...cssModules);\n\n    const serverRoot = getMetroServerRoot(this.projectRoot);\n\n    // HACK: Maybe this should be done in the serializer.\n    const clientBoundariesAsOpaqueIds = clientBoundaries.map((boundary) =>\n      // NOTE(cedric): relative module specifiers / IDs should always be POSIX formatted\n      toPosixPath(path.relative(serverRoot, boundary))\n    );\n    const moduleIdToSplitBundle = (\n      bundle.artifacts\n        .map((artifact) => artifact?.metadata?.paths && Object.values(artifact.metadata.paths))\n        .filter(Boolean)\n        .flat() as Record<string, string>[]\n    ).reduce((acc, paths) => ({ ...acc, ...paths }), {});\n\n    debug('SSR Manifest:', moduleIdToSplitBundle, clientBoundariesAsOpaqueIds);\n\n    const ssrManifest = new Map<string, string | null>();\n\n    if (Object.keys(moduleIdToSplitBundle).length) {\n      clientBoundariesAsOpaqueIds.forEach((boundary) => {\n        if (boundary in moduleIdToSplitBundle) {\n          ssrManifest.set(boundary, moduleIdToSplitBundle[boundary]);\n        } else {\n          throw new Error(\n            `Could not find boundary \"${boundary}\" in the SSR manifest. Available: ${Object.keys(moduleIdToSplitBundle).join(', ')}`\n          );\n        }\n      });\n    } else {\n      // Native apps with bundle splitting disabled.\n      debug('No split bundles');\n      clientBoundariesAsOpaqueIds.forEach((boundary) => {\n        ssrManifest.set(boundary, null);\n      });\n    }\n\n    const routerOptions = exp.extra?.router;\n\n    // Export the static RSC files\n    await this.rscRenderer!.exportRoutesAsync(\n      {\n        platform: options.platform,\n        ssrManifest,\n        routerOptions,\n      },\n      files\n    );\n\n    // Save the SSR manifest so we can perform more replacements in the server renderer and with server actions.\n    files.set(`_expo/rsc/${options.platform}/ssr-manifest.js`, {\n      targetDomain: 'server',\n      contents:\n        'module.exports = ' +\n        JSON.stringify(\n          // TODO: Add a less leaky version of this across the framework with just [key, value] (module ID, chunk).\n          Object.fromEntries(\n            Array.from(ssrManifest.entries()).map(([key, value]) => [\n              // Must match babel plugin.\n              './' + toPosixPath(path.relative(this.projectRoot, path.join(serverRoot, key))),\n              [key, value],\n            ])\n          )\n        ),\n    });\n\n    return { ...bundle, files };\n  }\n\n  async legacySinglePageExportBundleAsync(\n    options: Omit<\n      ExpoMetroOptions,\n      'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment' | 'hosted'\n    >,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{ artifacts: SerialAsset[]; assets: readonly BundleAssetWithFileHashes[] }> {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(options.mainModuleName != null, 'mainModuleName must be provided in options.');\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling legacySinglePageExportBundleAsync.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      ...this.instanceMetroOptions,\n      baseUrl,\n      routerRoot,\n      isExporting,\n      ...options,\n      environment: 'client',\n      serializerOutput: 'static',\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    if (!opts.mainModuleName.startsWith('/') && !path.isAbsolute(opts.mainModuleName)) {\n      opts.mainModuleName = './' + opts.mainModuleName;\n    }\n\n    const output = await this.metroLoadModuleContents(opts.mainModuleName, opts, extraOptions);\n\n    return {\n      artifacts: output.artifacts!,\n      assets: output.assets!,\n    };\n  }\n\n  async watchEnvironmentVariables() {\n    if (!this.instance) {\n      throw new Error(\n        'Cannot observe environment variable changes without a running Metro instance.'\n      );\n    }\n    if (!this.metro) {\n      // This can happen when the run command is used and the server is already running in another\n      // process.\n      debug('Skipping Environment Variable observation because Metro is not running (headless).');\n      return;\n    }\n\n    observeFileChanges(\n      {\n        metro: this.metro,\n        server: this.instance.server,\n      },\n      getEnvFiles(this.projectRoot),\n      () => {\n        debug('Reloading environment variables...');\n        // Force reload the environment variables.\n        reloadEnvFiles(this.projectRoot);\n      }\n    );\n  }\n\n  rscRenderer: Awaited<ReturnType<typeof createServerComponentsMiddleware>> | null = null;\n\n  protected async startImplementationAsync(\n    options: BundlerStartOptions\n  ): Promise<DevServerInstance> {\n    options.port = await this.resolvePortAsync(options);\n    await this.initUrlCreator(options);\n\n    const config = getConfig(this.projectRoot, { skipSDKVersionRequirement: true });\n    const { exp } = config;\n    // NOTE: This will change in the future when it's less experimental, we enable React 19, and turn on more RSC flags by default.\n    const isReactServerComponentsEnabled =\n      !!exp.experiments?.reactServerComponentRoutes || !!exp.experiments?.reactServerFunctions;\n    const isReactServerActionsOnlyEnabled =\n      !exp.experiments?.reactServerComponentRoutes && !!exp.experiments?.reactServerFunctions;\n    this.isReactServerComponentsEnabled = isReactServerComponentsEnabled;\n    this.isReactServerRoutesEnabled = !!exp.experiments?.reactServerComponentRoutes;\n\n    const useServerRendering = ['static', 'server'].includes(exp.web?.output ?? '');\n    const hasApiRoutes = isReactServerComponentsEnabled || exp.web?.output === 'server';\n    const baseUrl = getBaseUrlFromExpoConfig(exp);\n    const asyncRoutes = getAsyncRoutesFromExpoConfig(exp, options.mode ?? 'development', 'web');\n    const routerRoot = getRouterDirectoryModuleIdWithManifest(this.projectRoot, exp);\n    const reactCompiler = !!exp.experiments?.reactCompiler;\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const mode = options.mode ?? 'development';\n\n    const routerOptions = exp.extra?.router;\n\n    if (isReactServerComponentsEnabled && exp.web?.output === 'static') {\n      throw new CommandError(\n        `Experimental server component support does not support 'web.output: ${exp.web!.output}' yet. Use 'web.output: \"server\"' during the experimental phase.`\n      );\n    }\n\n    // Error early about the window.location polyfill when React Server Components are enabled.\n    if (isReactServerComponentsEnabled && exp?.extra?.router?.origin === false) {\n      const configPath = config.dynamicConfigPath ?? config.staticConfigPath ?? '/app.json';\n      const configFileName = path.basename(configPath);\n      throw new CommandError(\n        `The Expo Router \"origin\" property in the Expo config (${configFileName}) cannot be \"false\" when React Server Components is enabled. Remove it from the ${configFileName} file and try again.`\n      );\n    }\n\n    const instanceMetroOptions = {\n      isExporting: !!options.isExporting,\n      baseUrl,\n      mode,\n      routerRoot,\n      reactCompiler,\n      minify: options.minify,\n      asyncRoutes,\n      // Options that are changing between platforms like engine, platform, and environment aren't set here.\n    };\n    this.instanceMetroOptions = instanceMetroOptions;\n\n    const parsedOptions = {\n      host: options.location.hostType === 'localhost' ? 'localhost' : undefined,\n      port: options.port,\n      maxWorkers: options.maxWorkers,\n      resetCache: options.resetDevServer,\n    };\n\n    event('start', {\n      mode,\n      web: this.isTargetingWeb(),\n      baseUrl,\n      asyncRoutes,\n      routerRoot: event.path(appDir),\n      serverComponents: this.isReactServerComponentsEnabled,\n      serverActions: isReactServerActionsOnlyEnabled,\n      serverRendering: useServerRendering,\n      apiRoutes: hasApiRoutes,\n      exporting: !!options.isExporting,\n    });\n\n    const { metro, hmrServer, server, middleware, messageSocket } = await instantiateMetroAsync(\n      this,\n      parsedOptions,\n      {\n        isExporting: !!options.isExporting,\n        exp,\n      }\n    );\n\n    const protocol = server instanceof https.Server ? 'https' : 'http';\n\n    // Required for symbolication:\n    process.env.EXPO_DEV_SERVER_ORIGIN = `${protocol}://localhost:${options.port}`;\n\n    if (!options.isExporting) {\n      const manifestMiddleware = await this.getManifestMiddlewareAsync(options);\n\n      // Important that we noop source maps for context modules as soon as possible.\n      prependMiddleware(middleware, new ContextModuleSourceMapsMiddleware().getHandler());\n\n      // We need the manifest handler to be the first middleware to run so our\n      // routes take precedence over static files. For example, the manifest is\n      // served from '/' and if the user has an index.html file in their project\n      // then the manifest handler will never run, the static middleware will run\n      // and serve index.html instead of the manifest.\n      // https://github.com/expo/expo/issues/13114\n      prependMiddleware(middleware, manifestMiddleware.getHandler());\n\n      middleware.use(\n        new InterstitialPageMiddleware(this.projectRoot, {\n          // TODO: Prevent this from becoming stale.\n          scheme: options.location.scheme ?? null,\n        }).getHandler()\n      );\n      middleware.use(\n        new DevToolsPluginMiddleware(this.projectRoot, this.devToolsPluginManager).getHandler()\n      );\n\n      const deepLinkMiddleware = new RuntimeRedirectMiddleware(this.projectRoot, {\n        getLocation: ({ runtime }) => {\n          if (runtime === 'custom') {\n            return this.urlCreator?.constructDevClientUrl();\n          } else {\n            return this.urlCreator?.constructUrl({\n              scheme: 'exp',\n            });\n          }\n        },\n      });\n      middleware.use(deepLinkMiddleware.getHandler());\n\n      const serverRoot = getMetroServerRoot(this.projectRoot);\n\n      const domComponentRenderer = createDomComponentsMiddleware(\n        {\n          metroRoot: serverRoot,\n          projectRoot: this.projectRoot,\n        },\n        instanceMetroOptions\n      );\n      // Add support for DOM components.\n      // TODO: Maybe put behind a flag for now?\n      middleware.use(domComponentRenderer);\n\n      middleware.use(\n        new CreateFileMiddleware({\n          metroRoot: serverRoot,\n          projectRoot: this.projectRoot,\n          appDir,\n        }).getHandler()\n      );\n\n      // For providing info to the error overlay.\n      middleware.use((req: ServerRequest, res: ServerResponse, next: ServerNext) => {\n        // Use by `@expo/log-box` https://github.com/expo/expo/blob/f29b9f3715e42dca87bf3eebf11f7e7dd1ff73c1/packages/%40expo/log-box/src/utils/devServerEndpoints.ts#L82\n        if (req.url?.startsWith('/_expo/error-overlay-meta')) {\n          res.statusCode = 200;\n          res.setHeader('Content-Type', 'application/json');\n          res.end(\n            JSON.stringify({\n              projectRoot: this.projectRoot,\n              serverRoot,\n              sdkVersion: exp.sdkVersion,\n            })\n          );\n          return;\n        }\n        return next();\n      });\n\n      // Append support for redirecting unhandled requests to the index.html page on web.\n      if (this.isTargetingWeb()) {\n        // This MUST be after the manifest middleware so it doesn't have a chance to serve the template `public/index.html`.\n        middleware.use(new ServeStaticMiddleware(this.projectRoot).getHandler());\n\n        // This should come after the static middleware so it doesn't serve the favicon from `public/favicon.ico`.\n        middleware.use(new FaviconMiddleware(this.projectRoot).getHandler());\n      }\n\n      if (useServerRendering || isReactServerComponentsEnabled) {\n        observeAnyFileChanges(\n          {\n            metro,\n            server,\n          },\n          (events) => {\n            if (hasApiRoutes) {\n              // NOTE(EvanBacon): We aren't sure what files the API routes are using so we'll just invalidate\n              // aggressively to ensure we always have the latest. The only caching we really get here is for\n              // cases where the user is making subsequent requests to the same API route without changing anything.\n              // This is useful for testing but pretty suboptimal. Luckily our caching is pretty aggressive so it makes\n              // up for a lot of the overhead.\n              this.invalidateApiRouteCache();\n            } else if (!hasWarnedAboutApiRoutes()) {\n              for (const event of events) {\n                if (\n                  // If the user did not delete a file that matches the Expo Router API Route convention, then we should warn that\n                  // API Routes are not enabled in the project.\n                  event.metadata?.type !== 'd' &&\n                  // Ensure the file is in the project's routes directory to prevent false positives in monorepos.\n                  event.filePath.startsWith(appDir) &&\n                  isApiRouteConvention(event.filePath)\n                ) {\n                  warnInvalidWebOutput();\n                }\n              }\n            }\n\n            // Handle loader file changes for HMR\n            if (exp.extra?.router?.unstable_useServerDataLoaders) {\n              for (const event of events) {\n                if (event.metadata?.type !== 'd') {\n                  this.handleLoaderFileChange(event.filePath);\n                }\n              }\n            }\n          }\n        );\n      }\n\n      // If React 19 is enabled, then add RSC middleware to the dev server.\n      if (isReactServerComponentsEnabled) {\n        this.bindRSCDevModuleInjectionHandler();\n        const rscMiddleware = createServerComponentsMiddleware(this.projectRoot, {\n          instanceMetroOptions: this.instanceMetroOptions,\n          rscPath: '/_flight',\n          ssrLoadModule: this.ssrLoadModule.bind(this),\n          ssrLoadModuleArtifacts: this.metroImportAsArtifactsAsync.bind(this),\n          useClientRouter: isReactServerActionsOnlyEnabled,\n          createModuleId: metro._createModuleId.bind(metro),\n          routerOptions,\n        });\n        this.rscRenderer = rscMiddleware;\n        this.onReloadRscEvent = rscMiddleware.onReloadRscEvent;\n      }\n\n      // Append support for redirecting unhandled requests to the index.html page on web.\n      if (this.isTargetingWeb()) {\n        // Use `createRouteHandlerMiddleware()` when either of the following is true:\n        //  - Server rendering is enabled (server/static output)\n        //  - RSC is enabled. Even in `single` output mode, RSC needs the route handler\n        if (!useServerRendering && !isReactServerComponentsEnabled) {\n          middleware.use(\n            new HistoryFallbackMiddleware(manifestMiddleware.getHandler().internal).getHandler()\n          );\n        } else {\n          middleware.use(\n            createRouteHandlerMiddleware(this.projectRoot, {\n              appDir,\n              routerRoot,\n              config,\n              ...config.exp.extra?.router,\n              bundleApiRoute: (functionFilePath) =>\n                this.ssrImportApiRoute(functionFilePath, { platform: 'web' }),\n              executeLoaderAsync: async (route, request) => {\n                const url = new URL(request.url);\n                const resolvedLoaderRoute = fromServerManifestRoute(url.pathname, route);\n                if (!resolvedLoaderRoute) {\n                  return undefined;\n                }\n                // Only pass the request in SSR mode (server output with SSR enabled).\n                // In static mode, loaders should not receive request data.\n                const isSSREnabled =\n                  exp.web?.output === 'server' &&\n                  exp.extra?.router?.unstable_useServerRendering === true;\n                return this.executeServerDataLoaderAsync(\n                  url,\n                  resolvedLoaderRoute,\n                  isSSREnabled ? request : undefined\n                );\n              },\n              getStaticPageAsync: async (pathname, route, request) => {\n                // TODO: Add server rendering when RSC is enabled.\n                if (isReactServerComponentsEnabled) {\n                  // NOTE: This is a temporary hack to return the SPA/template index.html in development when RSC is enabled.\n                  // While this technically works, it doesn't provide the correct experience of server rendering the React code to HTML first.\n                  const html = await manifestMiddleware.getSingleHtmlTemplateAsync();\n                  return { content: html };\n                }\n\n                // Non-RSC apps will bundle the static HTML for a given pathname and respond with it.\n                return this.getStaticPageAsync(pathname, route, request);\n              },\n              rsc: isReactServerComponentsEnabled\n                ? {\n                    path: '/_flight',\n                    handler: this.rscRenderer!.handler,\n                  }\n                : undefined,\n            })\n          );\n        }\n      }\n    } else {\n      // If React 19 is enabled, then add RSC middleware to the dev server.\n      if (isReactServerComponentsEnabled) {\n        this.bindRSCDevModuleInjectionHandler();\n        const rscMiddleware = createServerComponentsMiddleware(this.projectRoot, {\n          instanceMetroOptions: this.instanceMetroOptions,\n          rscPath: '/_flight',\n          ssrLoadModule: this.ssrLoadModule.bind(this),\n          ssrLoadModuleArtifacts: this.metroImportAsArtifactsAsync.bind(this),\n          useClientRouter: isReactServerActionsOnlyEnabled,\n          createModuleId: metro._createModuleId.bind(metro),\n          routerOptions,\n        });\n        this.rscRenderer = rscMiddleware;\n      }\n    }\n    // Extend the close method to ensure that we clean up the local info.\n    const originalClose = server.close.bind(server);\n\n    server.close = (callback?: (err?: Error) => void) => {\n      return originalClose((err?: Error) => {\n        this.instance = null;\n        this.metro = null;\n        this.hmrServer = null;\n        this.ssrHmrClients = new Map();\n        callback?.(err);\n      });\n    };\n\n    this.metro = metro;\n    this.hmrServer = hmrServer;\n    return {\n      server,\n      location: {\n        // The port is the main thing we want to send back.\n        port: options.port,\n        // localhost isn't always correct.\n        host: 'localhost',\n        url: `${protocol}://localhost:${options.port}`,\n        protocol,\n      },\n      middleware,\n      messageSocket,\n    };\n  }\n\n  private onReloadRscEvent: ((platform: string) => void) | null = null;\n\n  private async registerSsrHmrAsync(url: string, onReload: (platform: string[]) => void) {\n    if (!this.hmrServer || this.ssrHmrClients.has(url)) {\n      return;\n    }\n\n    debug('[SSR] Register HMR:', url);\n\n    const sendFn = (message: string) => {\n      const data = JSON.parse(String(message)) as { type: string; body: any };\n\n      switch (data.type) {\n        case 'bundle-registered':\n        case 'update-done':\n        case 'update-start':\n          break;\n        case 'update':\n          {\n            const update = data.body;\n            const {\n              isInitialUpdate,\n              added,\n              modified,\n              deleted,\n            }: {\n              isInitialUpdate?: boolean;\n              added: {\n                module: [number | string, string];\n                sourceURL: string;\n                sourceMappingURL: string;\n              }[];\n              modified: {\n                module: [number | string, string];\n                sourceURL: string;\n                sourceMappingURL: string;\n              }[];\n              deleted: (number | string)[];\n            } = update;\n\n            const hasUpdate = added.length || modified.length || deleted.length;\n\n            // NOTE: We throw away the updates and instead simply send a trigger to the client to re-fetch the server route.\n            if (!isInitialUpdate && hasUpdate) {\n              // Clear all SSR modules before sending the reload event. This ensures that the next event will rebuild the in-memory state from scratch.\n              if (typeof globalThis.__c === 'function') globalThis.__c();\n\n              const allModuleIds = new Set(\n                [...added, ...modified].map((m) => m.module[0]).concat(deleted)\n              );\n\n              const platforms = unique(\n                Array.from(allModuleIds)\n                  .map((moduleId) => {\n                    if (typeof moduleId !== 'string') {\n                      return null;\n                    }\n                    // Extract platforms from the module IDs.\n                    return moduleId.match(/[?&]platform=([\\w]+)/)?.[1] ?? null;\n                  })\n                  .filter(Boolean)\n              ) as string[];\n\n              onReload(platforms);\n            }\n          }\n          break;\n        case 'error':\n          // GraphNotFound can mean that we have an issue in metroOptions where the URL doesn't match the object props.\n          Log.error('[SSR] HMR Error: ' + JSON.stringify(data, null, 2));\n\n          if (data.body?.type === 'GraphNotFoundError') {\n            Log.error(\n              'Available SSR HMR keys:',\n              `${this.metro?._bundler._revisionsByGraphId.keys()}`\n            );\n          }\n          break;\n        default:\n          debug('Unknown HMR message:', data);\n          break;\n      }\n    };\n\n    const client = await this.hmrServer!.onClientConnect(url, sendFn);\n    this.ssrHmrClients.set(url, client);\n    // Opt in...\n    client.optedIntoHMR = true;\n    await this.hmrServer!._registerEntryPoint(client, url, sendFn);\n  }\n\n  public async waitForTypeScriptAsync(): Promise<boolean> {\n    if (!this.instance) {\n      throw new Error('Cannot wait for TypeScript without a running server.');\n    }\n\n    return new Promise<boolean>((resolve) => {\n      if (!this.metro) {\n        // This can happen when the run command is used and the server is already running in another\n        // process. In this case we can't wait for the TypeScript check to complete because we don't\n        // have access to the Metro server.\n        debug('Skipping TypeScript check because Metro is not running (headless).');\n        return resolve(false);\n      }\n\n      const off = metroWatchTypeScriptFiles({\n        projectRoot: this.projectRoot,\n        server: this.instance!.server,\n        metro: this.metro,\n        tsconfig: true,\n        throttle: true,\n        eventTypes: ['change', 'add'],\n        callback: async () => {\n          // Run once, this prevents the TypeScript project prerequisite from running on every file change.\n          off();\n          const { TypeScriptProjectPrerequisite } = await import(\n            '../../doctor/typescript/TypeScriptProjectPrerequisite.js'\n          );\n\n          try {\n            const req = new TypeScriptProjectPrerequisite(this.projectRoot);\n            await req.bootstrapAsync();\n            resolve(true);\n          } catch (error: any) {\n            // Ensure the process doesn't fail if the TypeScript check fails.\n            // This could happen during the install.\n            Log.log();\n            Log.error(\n              chalk.red`Failed to automatically setup TypeScript for your project. Try restarting the dev server to fix.`\n            );\n            Log.exception(error);\n            resolve(false);\n          }\n        },\n      });\n    });\n  }\n\n  public async startTypeScriptServices() {\n    return startTypescriptTypeGenerationAsync({\n      server: this.instance?.server,\n      metro: this.metro,\n      projectRoot: this.projectRoot,\n    });\n  }\n\n  protected getConfigModuleIds(): string[] {\n    return ['./metro.config.js', './metro.config.json', './rn-cli.config.js'];\n  }\n\n  // API Routes\n\n  private pendingRouteOperations = new Map<string, Promise<SSRModuleContentsResult | null>>();\n\n  // Bundle the API Route with Metro and return the string contents to be evaluated in the server.\n  private async bundleApiRoute(\n    filePath: string,\n    { platform }: { platform: string }\n  ): Promise<SSRModuleContentsResult | null | undefined> {\n    if (this.pendingRouteOperations.has(filePath)) {\n      return this.pendingRouteOperations.get(filePath);\n    }\n    const bundleAsync = async (): Promise<SSRModuleContentsResult> => {\n      try {\n        debug('Bundle API route:', this.instanceMetroOptions.routerRoot, filePath);\n        return await this.ssrLoadModuleContents(filePath, {\n          isExporting: this.instanceMetroOptions.isExporting,\n          platform,\n        });\n      } catch (error: any) {\n        const appDir = this.instanceMetroOptions?.routerRoot\n          ? path.join(this.projectRoot, this.instanceMetroOptions!.routerRoot!)\n          : undefined;\n        const relativePath = appDir ? path.relative(appDir, filePath) : filePath;\n\n        // Expected errors: invalid syntax, missing resolutions.\n        // Wrap with command error for better error messages.\n        const err = new CommandError(\n          'API_ROUTE',\n          chalk`Failed to bundle API Route: {bold ${relativePath}}\\n\\n` + error.message\n        );\n\n        for (const key in error) {\n          err[key] = error[key];\n        }\n\n        throw err;\n      } finally {\n        // pendingRouteOperations.delete(filepath);\n      }\n    };\n    const route = bundleAsync();\n\n    this.pendingRouteOperations.set(filePath, route);\n    return route;\n  }\n\n  private async ssrImportApiRoute(\n    filePath: string,\n    { platform }: { platform: string }\n  ): Promise<null | Record<string, Function> | Response> {\n    // TODO: Cache the evaluated function.\n    try {\n      const apiRoute = await this.bundleApiRoute(filePath, { platform });\n\n      if (!apiRoute?.src) {\n        return null;\n      }\n      return evalMetroNoHandling(this.projectRoot, apiRoute.src, apiRoute.filename);\n    } catch (error) {\n      // Format any errors that were thrown in the global scope of the evaluation.\n      if (error instanceof Error) {\n        try {\n          const htmlServerError = await getErrorOverlayHtmlAsync({\n            error,\n            projectRoot: this.projectRoot,\n            routerRoot: this.instanceMetroOptions.routerRoot!,\n          });\n\n          return new Response(htmlServerError, {\n            status: 500,\n            headers: {\n              'Content-Type': 'text/html',\n            },\n          });\n        } catch (internalError) {\n          debug('Failed to generate Metro server error UI for API Route error:', internalError);\n          throw error;\n        }\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  private invalidateApiRouteCache() {\n    this.pendingRouteOperations.clear();\n  }\n\n  /**\n   * Execute a route's loader function. Used during development and SSG to fetch data required by\n   * routes.\n   *\n   * This function is used during development and production builds, and **must** receive a valid\n   * matched route.\n   *\n   * @experimental\n   */\n  async executeServerDataLoaderAsync(\n    location: URL,\n    route: ResolvedLoaderRoute,\n    // The `request` object is only available when using SSR\n    request?: ImmutableRequest\n  ): Promise<Response | undefined> {\n    const { exp } = getConfig(this.projectRoot);\n    const { unstable_useServerDataLoaders, unstable_useServerRendering } = exp.extra?.router;\n\n    if (!unstable_useServerDataLoaders) {\n      throw new CommandError(\n        'LOADERS_NOT_ENABLED',\n        'Server data loaders are not enabled. Add `unstable_useServerDataLoaders` to your `expo-router` plugin config.'\n      );\n    }\n\n    const { routerRoot } = this.instanceMetroOptions;\n    assert(\n      routerRoot != null,\n      'The server must be started before calling executeRouteLoaderAsync.'\n    );\n\n    try {\n      debug(`Matched ${location.pathname} to file: ${route.file}`);\n\n      const appDir = path.join(this.projectRoot, routerRoot);\n      let modulePath = route.file;\n      modulePath = path.isAbsolute(modulePath) ? modulePath : path.join(appDir, modulePath);\n      modulePath = modulePath.replace(/\\.(js|ts)x?$/, '');\n\n      debug('Using loader module path: ', modulePath);\n\n      const routeModule = await this.ssrLoadModule<any>(modulePath, {\n        environment: 'node',\n        isLoaderBundle: true,\n      });\n\n      if (routeModule.loader) {\n        // Register this module for loader HMR\n        this.setupLoaderHmr(modulePath);\n\n        const maybeResponse = await routeModule.loader(request, route.params);\n\n        let data: unknown;\n        if (maybeResponse instanceof Response) {\n          debug('Loader returned Response for location:', location.pathname);\n\n          // In SSR, preserve `Response` from the loader\n          if (exp.web?.output === 'server' && unstable_useServerRendering) {\n            return maybeResponse;\n          }\n\n          // In SSG, extract body\n          data = await maybeResponse.json();\n        } else {\n          data = maybeResponse;\n        }\n\n        debug('Loader data:', data ?? null, ' for location:', location.pathname);\n        return Response.json(data ?? null);\n      }\n\n      debug('No loader found for location:', location.pathname);\n      return undefined;\n    } catch (error: any) {\n      throw new CommandError(\n        'LOADER_EXECUTION_FAILED',\n        `Failed to execute loader for route \"${location.pathname}\": ${error.message}`\n      );\n    }\n  }\n\n  /**\n   * Bundle a loader module with Metro and return the string contents.\n   */\n  private async bundleLoader(\n    filePath: string,\n    { platform }: { platform: string }\n  ): Promise<SSRModuleContentsResult> {\n    try {\n      debug('Bundle loader:', filePath);\n      return await this.ssrLoadModuleContents(filePath, {\n        isExporting: this.instanceMetroOptions.isExporting,\n        platform,\n        environment: 'node',\n        isLoaderBundle: true,\n      });\n    } catch (error: any) {\n      debug('Failed to bundle loader:', filePath, ':', error.message);\n      throw new CommandError(\n        'LOADER_BUNDLE',\n        chalk`Failed to bundle loader: {bold ${filePath}}\\n\\n` + error.message\n      );\n    }\n  }\n\n  // Ensure the global is available for SSR CSS modules to inject client updates.\n  private bindRSCDevModuleInjectionHandler() {\n    // Used by SSR CSS modules to broadcast client updates.\n    globalThis.__expo_rsc_inject_module = this.sendClientModule.bind(this);\n  }\n\n  // NOTE: This can only target a single platform at a time (web).\n  // used for sending RSC CSS to the root client in development.\n  private sendClientModule({ code, id }: { code: string; id: string }) {\n    this.broadcastMessage('sendDevCommand', {\n      name: 'module-import',\n      data: {\n        code,\n        id,\n      },\n    });\n  }\n\n  // Metro HMR\n\n  private setupHmr(url: URL) {\n    const onReload = (platforms: string[] = []) => {\n      // Send reload command to client from Fast Refresh code.\n\n      if (!platforms.length) {\n        // TODO: When is this called?\n        this.broadcastMessage('sendDevCommand', {\n          name: 'rsc-reload',\n        });\n      } else {\n        for (const platform of platforms) {\n          this.onReloadRscEvent?.(platform);\n          this.broadcastMessage('sendDevCommand', {\n            name: 'rsc-reload',\n            platform,\n          });\n        }\n      }\n    };\n\n    this.registerSsrHmrAsync(url.toString(), onReload);\n  }\n\n  private watchedLoaderFiles: Set<string> = new Set();\n\n  private setupLoaderHmr(modulePath: string) {\n    if (this.watchedLoaderFiles.has(modulePath)) {\n      return;\n    }\n    this.watchedLoaderFiles.add(modulePath);\n\n    debug('[Loader HMR] Registering loader file for HMR:', modulePath);\n  }\n\n  private handleLoaderFileChange(changedFilePath: string) {\n    for (const loaderPath of this.watchedLoaderFiles) {\n      const possibleExtensions = ['.tsx', '.ts', '.jsx', '.js'];\n      const isLoaderFile = possibleExtensions.some(\n        (ext) => changedFilePath === loaderPath + ext || changedFilePath === loaderPath\n      );\n\n      if (isLoaderFile) {\n        debug('[Loader HMR] Loader file changed, triggering reload:', changedFilePath);\n        this.broadcastMessage('sendDevCommand', {\n          name: 'reload',\n        });\n      }\n    }\n  }\n\n  // Direct Metro access\n\n  // Emulates the Metro dev server .bundle endpoint without having to go through a server.\n  private async _bundleDirectAsync(\n    resolvedEntryFilePath: string,\n    {\n      transformOptions,\n      resolverOptions,\n      graphOptions,\n      serializerOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      serializerOptions: {\n        output?: 'string' | ({} & string);\n        modulesOnly: boolean;\n        runModule: boolean;\n        sourceMapUrl: string;\n        sourceUrl: string;\n        inlineSourceMap: boolean;\n        excludeSource: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ): Promise<BundleDirectResult> {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n    const buildNumber = this.metro.getNewBuildNumber();\n    const bundlePerfLogger = config.unstable_perfLoggerFactory?.('BUNDLING_REQUEST', {\n      key: buildNumber,\n    });\n\n    const onProgress = (transformedFileCount: number, totalFileCount: number) => {\n      this.metro?._reporter?.update?.({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_transform_progressed',\n        transformedFileCount,\n        totalFileCount,\n      });\n    };\n\n    const revPromise = this.getMetroRevision(resolvedEntryFilePath, {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    });\n\n    bundlePerfLogger?.point('resolvingAndTransformingDependencies_start');\n    bundlePerfLogger?.annotate({\n      bool: {\n        initial_build: revPromise == null,\n      },\n    });\n    this.metro?._reporter.update({\n      buildID: getBuildID(buildNumber),\n      bundleDetails: {\n        bundleType: transformOptions.type,\n        dev: transformOptions.dev,\n        entryFile: resolvedEntryFilePath,\n        minify: transformOptions.minify,\n        platform: transformOptions.platform,\n        customResolverOptions: resolverOptions.customResolverOptions,\n        customTransformOptions: transformOptions.customTransformOptions ?? {},\n      },\n      isPrefetch: false,\n      type: 'bundle_build_started',\n    });\n\n    try {\n      let delta: DeltaResult;\n      let revision: GraphRevision;\n\n      try {\n        // TODO: Some bug in Metro/RSC causes this to break when changing imports in server components.\n        // We should resolve the bug because it results in ~6x faster bundling to reuse the graph revision.\n        if (transformOptions.customTransformOptions?.environment === 'react-server') {\n          const props = await this.metro.getBundler().initializeGraph(\n            // NOTE: Using absolute path instead of relative input path is a breaking change.\n            // entryFile,\n            resolvedEntryFilePath,\n\n            transformOptions,\n            resolverOptions,\n            {\n              onProgress,\n              shallow: graphOptions.shallow,\n              lazy: graphOptions.lazy,\n            }\n          );\n          delta = props.delta;\n          revision = props.revision;\n        } else {\n          const props = await (revPromise != null\n            ? this.metro.getBundler().updateGraph(await revPromise, false)\n            : this.metro.getBundler().initializeGraph(\n                // NOTE: Using absolute path instead of relative input path is a breaking change.\n                // entryFile,\n                resolvedEntryFilePath,\n\n                transformOptions,\n                resolverOptions,\n                {\n                  onProgress,\n                  shallow: graphOptions.shallow,\n                  lazy: graphOptions.lazy,\n                }\n              ));\n          delta = props.delta;\n          revision = props.revision;\n        }\n      } catch (error) {\n        attachImportStackToRootMessage(error);\n        dropStackIfContainsCodeFrame(error);\n        throw error;\n      }\n\n      bundlePerfLogger?.annotate({\n        int: {\n          graph_node_count: revision.graph.dependencies.size,\n        },\n      });\n      bundlePerfLogger?.point('resolvingAndTransformingDependencies_end');\n      bundlePerfLogger?.point('serializingBundle_start');\n\n      const shouldAddToIgnoreList = this.metro._shouldAddModuleToIgnoreList.bind(this.metro);\n\n      const serializer = this.getMetroSerializer();\n\n      const options = {\n        asyncRequireModulePath: await this.metro._resolveRelativePath(\n          config.transformer.asyncRequireModulePath,\n          {\n            relativeTo: 'project',\n            resolverOptions,\n            transformOptions,\n          }\n        ),\n        // ...serializerOptions,\n        processModuleFilter: config.serializer.processModuleFilter,\n        createModuleId: this.metro._createModuleId,\n        getRunModuleStatement: config.serializer.getRunModuleStatement,\n        globalPrefix: config.transformer.globalPrefix,\n        includeAsyncPaths: graphOptions.lazy,\n        dev: transformOptions.dev,\n        projectRoot: config.projectRoot,\n        modulesOnly: serializerOptions.modulesOnly,\n        runBeforeMainModule: config.serializer.getModulesRunBeforeMainModule(\n          resolvedEntryFilePath\n          // path.relative(config.projectRoot, entryFile)\n        ),\n        runModule: serializerOptions.runModule,\n        sourceMapUrl: serializerOptions.sourceMapUrl,\n        sourceUrl: serializerOptions.sourceUrl,\n        inlineSourceMap: serializerOptions.inlineSourceMap,\n        serverRoot: config.server.unstable_serverRoot ?? config.projectRoot,\n        shouldAddToIgnoreList,\n\n        // TODO(@kitten): This is incoherently typed. The target should be typed to accept this coherently\n        // but we have no type overrides or a proper type chain for this\n        serializerOptions,\n      };\n\n      // TODO(@kitten): Yearns for a refactor. The typings here were and are questionable\n      const bundle = await serializer(\n        // NOTE: Using absolute path instead of relative input path is a breaking change.\n        // entryFile,\n        resolvedEntryFilePath,\n        revision.prepend,\n        revision.graph,\n        options\n      );\n\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_done',\n      });\n\n      bundlePerfLogger?.point('serializingBundle_end');\n\n      let bundleCode: string | null = null;\n      let bundleMap: string | null = null;\n\n      if (serializerOptions.output === 'static') {\n        try {\n          const parsed = typeof bundle === 'string' ? JSON.parse(bundle) : bundle;\n\n          assert(\n            'artifacts' in parsed && Array.isArray(parsed.artifacts),\n            'Expected serializer to return an object with key artifacts to contain an array of serial assets.'\n          );\n\n          const artifacts = parsed.artifacts as SerialAsset[];\n          const assets = parsed.assets;\n\n          const bundleCode = artifacts.filter((asset) => asset.type === 'js')[0];\n          const bundleMap = artifacts.filter((asset) => asset.type === 'map')?.[0]?.source ?? '';\n\n          return {\n            numModifiedFiles: delta.reset\n              ? delta.added.size + revision.prepend.length\n              : delta.added.size + delta.modified.size + delta.deleted.size,\n            lastModifiedDate: revision.date,\n            nextRevId: revision.id,\n            bundle: bundleCode.source,\n            map: bundleMap,\n            artifacts,\n            assets,\n          };\n        } catch (error: any) {\n          throw new Error(\n            'Serializer did not return expected format. The project copy of `expo/metro-config` may be out of date. Error: ' +\n              error.message\n          );\n        }\n      }\n\n      if (typeof bundle === 'string') {\n        bundleCode = bundle;\n\n        // Create the source map in a second pass...\n        let { prepend, graph } = revision;\n        if (serializerOptions.modulesOnly) {\n          prepend = [];\n        }\n\n        bundleMap = await sourceMapStringAsync(\n          [\n            //\n            ...prepend,\n            ...this.metro._getSortedModules(graph),\n          ],\n          {\n            excludeSource: serializerOptions.excludeSource,\n            processModuleFilter: config.serializer.processModuleFilter,\n            shouldAddToIgnoreList,\n          }\n        );\n      } else {\n        bundleCode = bundle.code;\n        bundleMap = bundle.map;\n      }\n\n      return {\n        numModifiedFiles: delta.reset\n          ? delta.added.size + revision.prepend.length\n          : delta.added.size + delta.modified.size + delta.deleted.size,\n        lastModifiedDate: revision.date,\n        nextRevId: revision.id,\n        bundle: bundleCode,\n        map: bundleMap,\n      };\n    } catch (error: any) {\n      // Mark the error so we know how to format and return it later.\n      if (error) {\n        error[IS_METRO_BUNDLE_ERROR_SYMBOL] = true;\n      }\n\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_failed',\n      });\n\n      throw error;\n    }\n  }\n\n  private getMetroSerializer() {\n    return (\n      this.metro?._config?.serializer.customSerializer ||\n      ((entryPoint, preModules, graph, options) =>\n        bundleToString(baseJSBundle(entryPoint, preModules, graph, options)).code)\n    );\n  }\n\n  private getMetroRevision(\n    resolvedEntryFilePath: string,\n    {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n\n    const graphId = getGraphId(resolvedEntryFilePath, transformOptions, {\n      unstable_allowRequireContext: config.transformer.unstable_allowRequireContext,\n      resolverOptions,\n      shallow: graphOptions.shallow,\n      lazy: graphOptions.lazy,\n    });\n    return this.metro.getBundler().getRevisionByGraphId(graphId);\n  }\n\n  private async resolveRelativePathAsync(\n    moduleId: string,\n    {\n      resolverOptions,\n      transformOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'cannot invoke resolveRelativePathAsync without metro instance');\n    return await this.metro._resolveRelativePath(convertPathToModuleSpecifier(moduleId), {\n      relativeTo: 'server',\n      resolverOptions,\n      transformOptions,\n    });\n  }\n}\n\nfunction getBuildID(buildNumber: number): string {\n  return buildNumber.toString(36);\n}\n\nfunction wrapBundle(str: string) {\n  // Skip the metro runtime so debugging is a bit easier.\n  // Replace the __r() call with an export statement.\n  // Use gm to apply to the last require line. This is needed when the bundle has side-effects.\n  return str.replace(/^(__r\\(.*\\);)$/gm, 'module.exports = $1');\n}\n\nasync function sourceMapStringAsync(\n  modules: readonly Module[],\n  options: SourceMapGeneratorOptions\n): Promise<string> {\n  return (await sourceMapGeneratorNonBlocking(modules, options)).toString(undefined, {\n    excludeSource: options.excludeSource,\n  });\n}\n\nfunction unique<T>(array: T[]): T[] {\n  return Array.from(new Set(array));\n}\n"],"names":["MetroBundlerDevServer","event","debug","require","EXPO_GO_METRO_PORT","DEV_CLIENT_METRO_PORT","events","t","BundlerDevServer","name","resolvePortAsync","options","port","devClient","Number","process","env","RCT_METRO_PORT","getFreePortAsync","exportServerRouteAsync","contents","artifactFilename","files","includeSourceMaps","descriptor","src","map","artifactBasename","encodeURIComponent","path","basename","replace","parsedMap","JSON","parse","mapData","stringify","version","sources","source","startsWith","projectRoot","relative","convertPathToModuleSpecifier","sourcesContent","Array","length","fill","names","mappings","targetDomain","set","fileData","exportMiddlewareAsync","manifest","appDir","outputDir","platform","middleware","middlewareFilePath","isAbsolute","file","join","bundleApiRoute","middlewareId","exportExpoRouterApiRoutesAsync","prerenderManifest","routerRoot","instanceMetroOptions","assert","getExpoRouterRoutesManifestAsync","Map","rscPath","isReactServerComponentsEnabled","apiRoutes","find","route","page","push","resolve","namedRegex","routeKeys","rsc","filepath","apiRouteId","htmlRoutes","exportExpoRouterRenderModuleAsync","renderModule","ssrLoadModuleContents","environment","exportExpoRouterLoadersAsync","entryPoints","entry","bundleLoader","pagePath","slice","loaderId","exp","getConfig","fetchManifest","extra","router","preserveRedirectAndRewrites","asJson","CommandError","getServerManifestAsync","getBuildTimeServerManifestAsync","getManifest","ssrLoadModule","isReactServerRoutesEnabled","serverManifest","htmlManifest","getStaticRenderFunctionAsync","url","getDevServerUrlOrAssert","getStaticContent","useServerRendering","unstable_useServerRendering","isExportingWithSSR","web","output","skipStaticParams","preserveApiRoutes","renderAsync","opts","location","URL","executeLoaderAsync","resolvedLoaderRoute","fromRuntimeManifestRoute","pathname","inflateManifest","undefined","executeServerDataLoaderAsync","getStaticResourcesAsync","mainModuleName","clientBoundaries","mode","minify","isExporting","baseUrl","reactCompiler","asyncRoutes","resolvedMainModuleName","resolveMainModuleName","metroImportAsArtifactsAsync","splitChunks","EXPO_NO_BUNDLE_SPLITTING","serializerIncludeMaps","lazy","EXPO_NO_METRO_LAZY","bytecode","getStaticPageAsync","request","devBundleUrlPathname","createBundleUrlPath","bundleStaticHtml","useServerDataLoaders","unstable_useServerDataLoaders","fromServerManifestRoute","loaderResult","loaderData","json","resolvedLoaderKey","resolveLoaderContextKey","contextKey","params","loader","data","key","artifacts","resources","staticHtml","Promise","all","content","serializeHtmlWithAssets","template","devBundleUrl","hydrate","EXPO_WEB_DEV_HYDRATE","filePath","specificOptions","results","serializerOutput","assets","filename","metroLoadModuleContents","extraOptions","inlineSourceMap","engine","expoBundleOptions","getMetroDirectBundleOptions","resolverOptions","customResolverOptions","dev","transformOptions","type","unstable_transformProfile","customTransformOptions","Object","create","resolvedEntryFilePath","resolveRelativePathAsync","createBundleOsPath","_bundleDirectAsync","graphOptions","shallow","serializerOptions","modulesOnly","runModule","sourceUrl","sourceMapUrl","bundle","rest","scriptContents","wrapBundle","cachedSourceMaps","nativeExportBundleAsync","singlePageReactServerComponentExportAsync","legacySinglePageExportBundleAsync","getReactServerReferences","unique","filter","a","artifact","metadata","reactServerReferences","ref","fileURLToFilePath","flat","Boolean","reactClientReferences","serverActionReferencesInServer","cssModules","rscRenderer","getExpoRouterClientReferencesAsync","domRoot","processClientBoundaries","newReactServerReferences","Error","allKnownReactServerReferences","nestedClientBoundaries","exportServerActionsAsync","hasUniqueClientBoundaries","some","boundary","includes","concat","serverRoot","getMetroServerRoot","clientBoundariesAsOpaqueIds","toPosixPath","moduleIdToSplitBundle","paths","values","reduce","acc","ssrManifest","keys","forEach","routerOptions","exportRoutesAsync","fromEntries","from","entries","value","watchEnvironmentVariables","instance","metro","observeFileChanges","server","getEnvFiles","reloadEnvFiles","startImplementationAsync","initUrlCreator","config","skipSDKVersionRequirement","experiments","reactServerComponentRoutes","reactServerFunctions","isReactServerActionsOnlyEnabled","hasApiRoutes","getBaseUrlFromExpoConfig","getAsyncRoutesFromExpoConfig","getRouterDirectoryModuleIdWithManifest","origin","configPath","dynamicConfigPath","staticConfigPath","configFileName","parsedOptions","host","hostType","maxWorkers","resetCache","resetDevServer","isTargetingWeb","serverComponents","serverActions","serverRendering","exporting","hmrServer","messageSocket","instantiateMetroAsync","protocol","https","Server","EXPO_DEV_SERVER_ORIGIN","manifestMiddleware","getManifestMiddlewareAsync","prependMiddleware","ContextModuleSourceMapsMiddleware","getHandler","use","InterstitialPageMiddleware","scheme","DevToolsPluginMiddleware","devToolsPluginManager","deepLinkMiddleware","RuntimeRedirectMiddleware","getLocation","runtime","urlCreator","constructDevClientUrl","constructUrl","domComponentRenderer","createDomComponentsMiddleware","metroRoot","CreateFileMiddleware","req","res","next","statusCode","setHeader","end","sdkVersion","ServeStaticMiddleware","FaviconMiddleware","observeAnyFileChanges","invalidateApiRouteCache","hasWarnedAboutApiRoutes","isApiRouteConvention","warnInvalidWebOutput","handleLoaderFileChange","bindRSCDevModuleInjectionHandler","rscMiddleware","createServerComponentsMiddleware","bind","ssrLoadModuleArtifacts","useClientRouter","createModuleId","_createModuleId","onReloadRscEvent","HistoryFallbackMiddleware","internal","createRouteHandlerMiddleware","functionFilePath","ssrImportApiRoute","isSSREnabled","html","getSingleHtmlTemplateAsync","handler","originalClose","close","callback","err","ssrHmrClients","registerSsrHmrAsync","onReload","has","sendFn","message","String","update","body","isInitialUpdate","added","modified","deleted","hasUpdate","globalThis","__c","allModuleIds","Set","m","module","platforms","moduleId","match","Log","error","_bundler","_revisionsByGraphId","client","onClientConnect","optedIntoHMR","_registerEntryPoint","waitForTypeScriptAsync","off","metroWatchTypeScriptFiles","tsconfig","throttle","eventTypes","TypeScriptProjectPrerequisite","bootstrapAsync","log","chalk","red","exception","startTypeScriptServices","startTypescriptTypeGenerationAsync","getConfigModuleIds","pendingRouteOperations","get","bundleAsync","relativePath","apiRoute","evalMetroNoHandling","htmlServerError","getErrorOverlayHtmlAsync","Response","status","headers","internalError","clear","modulePath","routeModule","isLoaderBundle","setupLoaderHmr","maybeResponse","__expo_rsc_inject_module","sendClientModule","code","id","broadcastMessage","setupHmr","toString","watchedLoaderFiles","add","changedFilePath","loaderPath","possibleExtensions","isLoaderFile","ext","_config","buildNumber","getNewBuildNumber","bundlePerfLogger","unstable_perfLoggerFactory","onProgress","transformedFileCount","totalFileCount","_reporter","buildID","getBuildID","revPromise","getMetroRevision","point","annotate","bool","initial_build","bundleDetails","bundleType","entryFile","isPrefetch","delta","revision","props","getBundler","initializeGraph","updateGraph","attachImportStackToRootMessage","dropStackIfContainsCodeFrame","int","graph_node_count","graph","dependencies","size","shouldAddToIgnoreList","_shouldAddModuleToIgnoreList","serializer","getMetroSerializer","asyncRequireModulePath","_resolveRelativePath","transformer","relativeTo","processModuleFilter","getRunModuleStatement","globalPrefix","includeAsyncPaths","runBeforeMainModule","getModulesRunBeforeMainModule","unstable_serverRoot","prepend","bundleCode","bundleMap","parsed","isArray","asset","numModifiedFiles","reset","lastModifiedDate","date","nextRevId","sourceMapStringAsync","_getSortedModules","excludeSource","IS_METRO_BUNDLE_ERROR_SYMBOL","customSerializer","entryPoint","preModules","bundleToString","baseJSBundle","graphId","getGraphId","unstable_allowRequireContext","getRevisionByGraphId","extras","getEmptyModulePath","resolver","emptyModulePath","hot","evalMetroAndWrapFunctions","str","modules","sourceMapGeneratorNonBlocking","array"],"mappings":"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"}