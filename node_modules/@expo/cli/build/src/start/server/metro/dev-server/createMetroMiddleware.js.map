{"version":3,"sources":["../../../../../../src/start/server/metro/dev-server/createMetroMiddleware.ts"],"sourcesContent":["import type { MetroConfig } from '@expo/metro/metro';\nimport connect from 'connect';\nimport { Body } from 'fetch-nodeshim';\n\nimport { compression } from './compression';\nimport { createEventsSocket } from './createEventSocket';\nimport { createMessagesSocket } from './createMessageSocket';\nimport { Log } from '../../../../log';\nimport { openInEditorAsync } from '../../../../utils/editor';\n\nexport function createMetroMiddleware(metroConfig: Pick<MetroConfig, 'projectRoot'>) {\n  const messages = createMessagesSocket({ logger: Log });\n  const events = createEventsSocket(messages);\n\n  const middleware = connect()\n    .use(noCacheMiddleware)\n    .use(compression)\n    // Support opening stack frames from clients directly in the editor\n    .use('/open-stack-frame', metroOpenStackFrameMiddleware)\n    // Support status check to detect if the packager needs to be started from the native side\n    .use('/status', createMetroStatusMiddleware(metroConfig));\n\n  return {\n    middleware,\n    messagesSocket: messages,\n    eventsSocket: events,\n    websocketEndpoints: {\n      [messages.endpoint]: messages.server,\n      [events.endpoint]: events.server,\n    },\n  };\n}\n\nconst noCacheMiddleware: connect.NextHandleFunction = (req, res, next) => {\n  res.setHeader('Surrogate-Control', 'no-store');\n  res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n  res.setHeader('Pragma', 'no-cache');\n  res.setHeader('Expires', '0');\n  next();\n};\n\nconst metroOpenStackFrameMiddleware: connect.NextHandleFunction = async (req, res, next) => {\n  if (req.method !== 'POST') {\n    return next();\n  }\n  try {\n    const frame = await new Body(req).json();\n    await openInEditorAsync(frame.file, frame.lineNumber);\n    return res.end('OK');\n  } catch {\n    res.statusCode = 400;\n    return res.end('Open stack frame requires the JSON stack frame as request body');\n  }\n};\n\nfunction createMetroStatusMiddleware(\n  metroConfig: Pick<MetroConfig, 'projectRoot'>\n): connect.NextHandleFunction {\n  return (_req, res) => {\n    res.setHeader('X-React-Native-Project-Root', encodeURI(metroConfig.projectRoot!));\n    res.end('packager-status:running');\n  };\n}\n"],"names":["createMetroMiddleware","metroConfig","messages","createMessagesSocket","logger","Log","events","createEventsSocket","middleware","connect","use","noCacheMiddleware","compression","metroOpenStackFrameMiddleware","createMetroStatusMiddleware","messagesSocket","eventsSocket","websocketEndpoints","endpoint","server","req","res","next","setHeader","method","frame","Body","json","openInEditorAsync","file","lineNumber","end","statusCode","_req","encodeURI","projectRoot"],"mappings":";;;;+BAUgBA;;;eAAAA;;;;gEATI;;;;;;;yBACC;;;;;;6BAEO;mCACO;qCACE;qBACjB;wBACc;;;;;;AAE3B,SAASA,sBAAsBC,WAA6C;IACjF,MAAMC,WAAWC,IAAAA,yCAAoB,EAAC;QAAEC,QAAQC,QAAG;IAAC;IACpD,MAAMC,SAASC,IAAAA,qCAAkB,EAACL;IAElC,MAAMM,aAAaC,IAAAA,kBAAO,IACvBC,GAAG,CAACC,mBACJD,GAAG,CAACE,wBAAW,CAChB,mEAAmE;KAClEF,GAAG,CAAC,qBAAqBG,8BAC1B,0FAA0F;KACzFH,GAAG,CAAC,WAAWI,4BAA4Bb;IAE9C,OAAO;QACLO;QACAO,gBAAgBb;QAChBc,cAAcV;QACdW,oBAAoB;YAClB,CAACf,SAASgB,QAAQ,CAAC,EAAEhB,SAASiB,MAAM;YACpC,CAACb,OAAOY,QAAQ,CAAC,EAAEZ,OAAOa,MAAM;QAClC;IACF;AACF;AAEA,MAAMR,oBAAgD,CAACS,KAAKC,KAAKC;IAC/DD,IAAIE,SAAS,CAAC,qBAAqB;IACnCF,IAAIE,SAAS,CAAC,iBAAiB;IAC/BF,IAAIE,SAAS,CAAC,UAAU;IACxBF,IAAIE,SAAS,CAAC,WAAW;IACzBD;AACF;AAEA,MAAMT,gCAA4D,OAAOO,KAAKC,KAAKC;IACjF,IAAIF,IAAII,MAAM,KAAK,QAAQ;QACzB,OAAOF;IACT;IACA,IAAI;QACF,MAAMG,QAAQ,MAAM,IAAIC,CAAAA,gBAAG,MAAC,CAACN,KAAKO,IAAI;QACtC,MAAMC,IAAAA,yBAAiB,EAACH,MAAMI,IAAI,EAAEJ,MAAMK,UAAU;QACpD,OAAOT,IAAIU,GAAG,CAAC;IACjB,EAAE,OAAM;QACNV,IAAIW,UAAU,GAAG;QACjB,OAAOX,IAAIU,GAAG,CAAC;IACjB;AACF;AAEA,SAASjB,4BACPb,WAA6C;IAE7C,OAAO,CAACgC,MAAMZ;QACZA,IAAIE,SAAS,CAAC,+BAA+BW,UAAUjC,YAAYkC,WAAW;QAC9Ed,IAAIU,GAAG,CAAC;IACV;AACF"}