{"version":3,"sources":["../../../../../src/start/server/metro/instantiateMetro.ts"],"sourcesContent":["import { type ExpoConfig, getConfig } from '@expo/config';\nimport { getMetroServerRoot } from '@expo/config/paths';\nimport type { Reporter } from '@expo/metro/metro';\nimport type Bundler from '@expo/metro/metro/Bundler';\nimport type { ReadOnlyGraph } from '@expo/metro/metro/DeltaBundler';\nimport type { TransformOptions } from '@expo/metro/metro/DeltaBundler/Worker';\nimport MetroHmrServer, { Client as MetroHmrClient } from '@expo/metro/metro/HmrServer';\nimport RevisionNotFoundError from '@expo/metro/metro/IncrementalBundler/RevisionNotFoundError';\nimport type MetroServer from '@expo/metro/metro/Server';\nimport formatBundlingError from '@expo/metro/metro/lib/formatBundlingError';\nimport { mergeConfig, resolveConfig, type ConfigT } from '@expo/metro/metro-config';\nimport { Terminal } from '@expo/metro/metro-core';\nimport { createStableModuleIdFactory, getDefaultConfig } from '@expo/metro-config';\nimport chalk from 'chalk';\nimport http from 'http';\nimport path from 'path';\n\nimport { createDevToolsPluginWebsocketEndpoint } from './DevToolsPluginWebsocketEndpoint';\nimport { MetroBundlerDevServer } from './MetroBundlerDevServer';\nimport { MetroTerminalReporter } from './MetroTerminalReporter';\nimport { attachAtlasAsync } from './debugging/attachAtlas';\nimport { createDebugMiddleware } from './debugging/createDebugMiddleware';\nimport { createMetroMiddleware } from './dev-server/createMetroMiddleware';\nimport { runServer, type SecureServerOptions } from './runServer-fork';\nimport { withMetroMultiPlatformAsync } from './withMetroMultiPlatform';\nimport { events, shouldReduceLogs } from '../../../events';\nimport { Log } from '../../../log';\nimport { env } from '../../../utils/env';\nimport { CommandError } from '../../../utils/errors';\nimport { createCorsMiddleware } from '../middleware/CorsMiddleware';\nimport { createJsInspectorMiddleware } from '../middleware/inspector/createJsInspectorMiddleware';\nimport { prependMiddleware } from '../middleware/mutations';\nimport { getPlatformBundlers } from '../platformBundlers';\n\n// prettier-ignore\nexport const event = events('metro', (t) => [\n  t.event<'config', {\n    serverRoot: string;\n    projectRoot: string;\n    exporting: boolean;\n    flags: {\n      autolinkingModuleResolution: boolean;\n      serverActions: boolean;\n      serverComponents: boolean;\n      reactCompiler: boolean;\n      optimizeGraph?: boolean;\n      treeshaking?: boolean;\n      logbox?: boolean;\n    };\n  }>(),\n  t.event<'instantiate', {\n    atlas: boolean;\n    workers: number | null;\n    host: string | null;\n    port: number | null;\n  }>(),\n]);\n\n// NOTE(@kitten): We pass a custom createStableModuleIdFactory function into the Metro module ID factory sometimes\ninterface MetroServerWithModuleIdMod extends MetroServer {\n  _createModuleId: ReturnType<typeof createStableModuleIdFactory> & ((path: string) => number);\n}\ninterface MetroHmrServerWithModuleIdMod extends MetroHmrServer<MetroHmrClient> {\n  _createModuleId: ReturnType<typeof createStableModuleIdFactory> & ((path: string) => number);\n}\n\n// From expo/dev-server but with ability to use custom logger.\ntype MessageSocket = {\n  broadcast: (method: string, params?: Record<string, any> | undefined) => void;\n};\n\n// TODO(@kitten): We assign this here to run server-side code bundled by metro\n// It's not isolated into a worker thread yet\n// Check `metro-require/require.ts` for how this setting is used\ndeclare namespace globalThis {\n  let __requireCycleIgnorePatterns: readonly RegExp[] | undefined;\n}\n\nfunction asWritable<T>(input: T): { -readonly [K in keyof T]: T[K] } {\n  return input;\n}\n\n// Wrap terminal and polyfill console.log so we can log during bundling without breaking the indicator.\nclass LogRespectingTerminal extends Terminal {\n  constructor(stream: import('node:net').Socket | import('node:stream').Writable) {\n    super(stream, { ttyPrint: true });\n\n    const sendLog = (...msg: any[]) => {\n      if (!msg.length) {\n        this.log('');\n      } else {\n        const [format, ...args] = msg;\n        this.log(format, ...args);\n      }\n      // Flush the logs to the terminal immediately so logs at the end of the process are not lost.\n      this.flush();\n    };\n\n    console.log = sendLog;\n    console.info = sendLog;\n  }\n}\n\n// Share one instance of Terminal for all instances of Metro.\nconst terminal = new LogRespectingTerminal(process.stdout);\n\ninterface LoadMetroConfigOptions {\n  maxWorkers?: number;\n  port?: number;\n  reporter?: Reporter;\n  resetCache?: boolean;\n}\n\nexport async function loadMetroConfigAsync(\n  projectRoot: string,\n  options: LoadMetroConfigOptions,\n  {\n    exp,\n    isExporting,\n    getMetroBundler,\n  }: { exp: ExpoConfig; isExporting: boolean; getMetroBundler: () => Bundler }\n) {\n  let reportEvent: ((event: any) => void) | undefined;\n\n  // We're resolving a monorepo root, higher up than the `projectRoot`. If this\n  // folder is different (presumably a parent) we're in a monorepo\n  const serverRoot = getMetroServerRoot(projectRoot);\n  const isWorkspace = serverRoot !== projectRoot;\n\n  // Autolinking Module Resolution will be enabled by default when we're in a monorepo\n  const autolinkingModuleResolutionEnabled =\n    exp.experiments?.autolinkingModuleResolution ?? isWorkspace;\n\n  const serverActionsEnabled =\n    exp.experiments?.reactServerFunctions ?? env.EXPO_UNSTABLE_SERVER_FUNCTIONS;\n  const serverComponentsEnabled = !!exp.experiments?.reactServerComponentRoutes;\n  if (serverActionsEnabled) {\n    process.env.EXPO_UNSTABLE_SERVER_FUNCTIONS = '1';\n  }\n\n  // NOTE: Enable all the experimental Metro flags when RSC is enabled.\n  if (serverComponentsEnabled || serverActionsEnabled) {\n    process.env.EXPO_USE_METRO_REQUIRE = '1';\n  }\n\n  if (exp.experiments?.reactCanary) {\n    Log.warn(`React 19 is enabled by default. Remove unused experiments.reactCanary flag.`);\n  }\n\n  const terminalReporter = new MetroTerminalReporter(serverRoot, terminal);\n\n  // NOTE: Allow external tools to override the metro config. This is considered internal and unstable\n  const configPath = env.EXPO_OVERRIDE_METRO_CONFIG ?? undefined;\n  const resolvedConfig = await resolveConfig(configPath, projectRoot);\n  const defaultConfig = getDefaultConfig(projectRoot);\n\n  let config: ConfigT = resolvedConfig.isEmpty\n    ? defaultConfig\n    : await mergeConfig(defaultConfig, resolvedConfig.config);\n\n  // Set the watchfolders to include the projectRoot, as Metro assumes this\n  // Force-override the reporter\n  config = {\n    ...config,\n\n    // See: `overrideConfigWithArguments` https://github.com/facebook/metro/blob/5059e26/packages/metro-config/src/loadConfig.js#L274-L339\n    // Compare to `LoadOptions` type (disregard `reporter` as we don't expose this)\n    resetCache: !!options.resetCache,\n    maxWorkers: options.maxWorkers ?? config.maxWorkers,\n    server: {\n      ...config.server,\n      port: options.port ?? config.server.port,\n    },\n\n    watchFolders: !config.watchFolders.includes(config.projectRoot)\n      ? [config.projectRoot, ...config.watchFolders]\n      : config.watchFolders,\n    reporter: {\n      update(event) {\n        terminalReporter.update(event);\n        if (reportEvent) {\n          reportEvent(event);\n        }\n      },\n    },\n  };\n\n  // NOTE(@kitten): `useWatchman` is currently enabled by default, but it also disables `forceNodeFilesystemAPI`.\n  // If we instead set it to the special value `null`, it gets enables but also bypasses the \"native find\" codepath,\n  // which is slower than just using the Node filesystem API\n  // See: https://github.com/facebook/metro/blob/b9c243f/packages/metro-file-map/src/index.js#L326\n  // See: https://github.com/facebook/metro/blob/b9c243f/packages/metro/src/node-haste/DependencyGraph/createFileMap.js#L109\n  if (config.resolver.useWatchman === true) {\n    asWritable(config.resolver).useWatchman = null as any;\n  }\n\n  globalThis.__requireCycleIgnorePatterns = config.resolver?.requireCycleIgnorePatterns;\n\n  if (isExporting) {\n    // This token will be used in the asset plugin to ensure the path is correct for writing locally.\n    asWritable(config.transformer).publicPath = `/assets?export_path=${\n      (exp.experiments?.baseUrl ?? '') + '/assets'\n    }`;\n  } else {\n    asWritable(config.transformer).publicPath = '/assets/?unstable_path=.';\n  }\n\n  const platformBundlers = getPlatformBundlers(projectRoot, exp);\n  const reduceLogs = shouldReduceLogs();\n\n  const reactCompilerEnabled = !!exp.experiments?.reactCompiler;\n  if (!reduceLogs && reactCompilerEnabled) {\n    Log.log(chalk.gray`React Compiler enabled`);\n  }\n\n  if (!reduceLogs && autolinkingModuleResolutionEnabled) {\n    Log.log(chalk.gray`Expo Autolinking module resolution enabled`);\n  }\n\n  if (env.EXPO_UNSTABLE_TREE_SHAKING && !env.EXPO_UNSTABLE_METRO_OPTIMIZE_GRAPH) {\n    throw new CommandError(\n      'EXPO_UNSTABLE_TREE_SHAKING requires EXPO_UNSTABLE_METRO_OPTIMIZE_GRAPH to be enabled.'\n    );\n  }\n\n  if (!reduceLogs && env.EXPO_UNSTABLE_METRO_OPTIMIZE_GRAPH) {\n    Log.warn(`Experimental bundle optimization is enabled.`);\n  }\n  if (!reduceLogs && env.EXPO_UNSTABLE_TREE_SHAKING) {\n    Log.warn(`Experimental tree shaking is enabled.`);\n  }\n  if (!reduceLogs && env.EXPO_UNSTABLE_LOG_BOX) {\n    Log.warn(`Experimental Expo LogBox is enabled.`);\n  }\n\n  if (!reduceLogs && serverActionsEnabled) {\n    Log.warn(\n      `React Server Functions (beta) are enabled. Route rendering mode: ${exp.experiments?.reactServerComponentRoutes ? 'server' : 'client'}`\n    );\n  }\n\n  config = await withMetroMultiPlatformAsync(projectRoot, {\n    config,\n    exp,\n    platformBundlers,\n    isTsconfigPathsEnabled: exp.experiments?.tsconfigPaths ?? true,\n    isAutolinkingResolverEnabled: autolinkingModuleResolutionEnabled,\n    isExporting,\n    isNamedRequiresEnabled: env.EXPO_USE_METRO_REQUIRE,\n    isReactServerComponentsEnabled: serverComponentsEnabled,\n    getMetroBundler,\n  });\n\n  event('config', {\n    serverRoot: event.path(serverRoot),\n    projectRoot: event.path(projectRoot),\n    exporting: isExporting,\n    flags: {\n      autolinkingModuleResolution: autolinkingModuleResolutionEnabled,\n      serverActions: serverActionsEnabled,\n      serverComponents: serverComponentsEnabled,\n      reactCompiler: reactCompilerEnabled,\n      optimizeGraph: env.EXPO_UNSTABLE_METRO_OPTIMIZE_GRAPH,\n      treeshaking: env.EXPO_UNSTABLE_TREE_SHAKING,\n      logbox: env.EXPO_UNSTABLE_LOG_BOX,\n    },\n  });\n\n  return {\n    config,\n    setEventReporter: (logger: (event: any) => void) => (reportEvent = logger),\n    reporter: terminalReporter,\n  };\n}\n\ninterface InstantiateMetroConfigOptions extends LoadMetroConfigOptions {\n  host?: string;\n}\n\n/** The most generic possible setup for Metro bundler. */\nexport async function instantiateMetroAsync(\n  metroBundler: MetroBundlerDevServer,\n  options: InstantiateMetroConfigOptions,\n  {\n    isExporting,\n    exp = getConfig(metroBundler.projectRoot, {\n      skipSDKVersionRequirement: true,\n    }).exp,\n  }: { isExporting: boolean; exp?: ExpoConfig }\n): Promise<{\n  metro: MetroServer;\n  hmrServer: MetroHmrServer<MetroHmrClient> | null;\n  server: http.Server;\n  middleware: any;\n  messageSocket: MessageSocket;\n}> {\n  const projectRoot = metroBundler.projectRoot;\n\n  const {\n    config: metroConfig,\n    setEventReporter,\n    reporter,\n  } = await loadMetroConfigAsync(projectRoot, options, {\n    exp,\n    isExporting,\n    getMetroBundler() {\n      return metro.getBundler().getBundler();\n    },\n  });\n\n  // Create the core middleware stack for Metro, including websocket listeners\n  const { middleware, messagesSocket, eventsSocket, websocketEndpoints } =\n    createMetroMiddleware(metroConfig);\n\n  // Get local URL to Metro bundler server (typically configured as 127.0.0.1:8081)\n  const serverBaseUrl = metroBundler\n    .getUrlCreator()\n    .constructUrl({ scheme: 'http', hostType: 'localhost' });\n\n  if (!isExporting) {\n    // Enable correct CORS headers for Expo Router features\n    prependMiddleware(middleware, createCorsMiddleware(exp));\n\n    // Enable debug middleware for CDP-related debugging\n    const { debugMiddleware, debugWebsocketEndpoints } = createDebugMiddleware({\n      serverBaseUrl,\n      reporter,\n    });\n    Object.assign(websocketEndpoints, debugWebsocketEndpoints);\n    middleware.use(debugMiddleware);\n    middleware.use('/_expo/debugger', createJsInspectorMiddleware());\n\n    // TODO(cedric): `enhanceMiddleware` is deprecated, but is currently used to unify the middleware stacks\n    // See: https://github.com/facebook/metro/commit/22e85fde85ec454792a1b70eba4253747a2587a9\n    // See: https://github.com/facebook/metro/commit/d0d554381f119bb80ab09dbd6a1d310b54737e52\n    const customEnhanceMiddleware = metroConfig.server.enhanceMiddleware;\n    asWritable(metroConfig.server).enhanceMiddleware = (\n      metroMiddleware: any,\n      server: MetroServer\n    ) => {\n      if (customEnhanceMiddleware) {\n        metroMiddleware = customEnhanceMiddleware(metroMiddleware, server);\n      }\n      return middleware.use(metroMiddleware);\n    };\n\n    const devtoolsWebsocketEndpoints = createDevToolsPluginWebsocketEndpoint();\n    Object.assign(websocketEndpoints, devtoolsWebsocketEndpoints);\n  }\n\n  // Attach Expo Atlas if enabled\n  await attachAtlasAsync({\n    isExporting,\n    exp,\n    projectRoot,\n    middleware,\n    metroConfig,\n    // NOTE(cedric): reset the Atlas file once, and reuse it for static exports\n    resetAtlasFile: isExporting,\n  });\n\n  // Support HTTPS based on the metro's tls server config\n  // TODO(@kitten): Remove cast once `@expo/metro` is updated to a Metro version that supports the tls config\n  const tls = (metroConfig.server as typeof metroConfig.server & { tls?: SecureServerOptions })\n    ?.tls;\n  const secureServerOptions = tls\n    ? {\n        key: tls.key,\n        cert: tls.cert,\n        ca: tls.ca,\n        requestCert: tls.requestCert,\n      }\n    : undefined;\n\n  const { address, server, hmrServer, metro } = await runServer(\n    metroBundler,\n    metroConfig,\n    {\n      host: options.host,\n      websocketEndpoints,\n      watch: !isExporting && isWatchEnabled(),\n      secureServerOptions,\n    },\n    {\n      mockServer: isExporting,\n    }\n  );\n\n  event('instantiate', {\n    atlas: env.EXPO_ATLAS,\n    workers: metroConfig.maxWorkers ?? null,\n    host: address?.address ?? null,\n    port: address?.port ?? null,\n  });\n\n  // Patch transform file to remove inconvenient customTransformOptions which are only used in single well-known files.\n  const originalTransformFile = metro\n    .getBundler()\n    .getBundler()\n    .transformFile.bind(metro.getBundler().getBundler());\n\n  metro.getBundler().getBundler().transformFile = async function (\n    filePath: string,\n    transformOptions: TransformOptions,\n    fileBuffer?: Buffer\n  ) {\n    return originalTransformFile(\n      filePath,\n      pruneCustomTransformOptions(\n        projectRoot,\n        filePath,\n        // Clone the options so we don't mutate the original.\n        {\n          ...transformOptions,\n          customTransformOptions: {\n            __proto__: null,\n            ...transformOptions.customTransformOptions,\n          },\n        }\n      ),\n      fileBuffer\n    );\n  };\n\n  setEventReporter(eventsSocket.reportMetroEvent);\n\n  // This function ensures that modules in source maps are sorted in the same\n  // order as in a plain JS bundle.\n  metro._getSortedModules = function (this: MetroServerWithModuleIdMod, graph: ReadOnlyGraph) {\n    const modules = [...graph.dependencies.values()];\n\n    const ctx = {\n      // TODO(@kitten): Increase type-safety here\n      platform: graph.transformOptions.platform!,\n      environment: graph.transformOptions.customTransformOptions?.environment,\n    };\n    // Assign IDs to modules in a consistent order\n    for (const module of modules) {\n      this._createModuleId(module.path, ctx);\n    }\n    // Sort by IDs\n    return modules.sort(\n      (a, b) => this._createModuleId(a.path, ctx) - this._createModuleId(b.path, ctx)\n    );\n  };\n\n  if (hmrServer) {\n    let hmrJSBundle:\n      | typeof import('@expo/metro-config/build/serializer/fork/hmrJSBundle').default\n      | typeof import('@expo/metro/metro/DeltaBundler/Serializers/hmrJSBundle').default;\n\n    try {\n      hmrJSBundle = require('@expo/metro-config/build/serializer/fork/hmrJSBundle').default;\n    } catch {\n      // TODO: Add fallback for monorepo tests up until the fork is merged.\n      Log.warn('Failed to load HMR serializer from @expo/metro-config, using fallback version.');\n      hmrJSBundle = require('@expo/metro/metro/DeltaBundler/Serializers/hmrJSBundle');\n    }\n\n    // Patch HMR Server to send more info to the `_createModuleId` function for deterministic module IDs and add support for serializing HMR updates the same as all other bundles.\n    hmrServer._prepareMessage = async function (\n      this: MetroHmrServerWithModuleIdMod,\n      group,\n      options,\n      changeEvent\n    ) {\n      // Fork of https://github.com/facebook/metro/blob/3b3e0aaf725cfa6907bf2c8b5fbc0da352d29efe/packages/metro/src/HmrServer.js#L327-L393\n      // with patch for `_createModuleId`.\n      const logger = !options.isInitialUpdate ? changeEvent?.logger : null;\n      try {\n        const revPromise = this._bundler.getRevision(group.revisionId);\n        if (!revPromise) {\n          return {\n            type: 'error',\n            body: formatBundlingError(new RevisionNotFoundError(group.revisionId)),\n          };\n        }\n        logger?.point('updateGraph_start');\n        const { revision, delta } = await this._bundler.updateGraph(await revPromise, false);\n        logger?.point('updateGraph_end');\n        this._clientGroups.delete(group.revisionId);\n        group.revisionId = revision.id;\n        for (const client of group.clients) {\n          client.revisionIds = client.revisionIds.filter(\n            (revisionId) => revisionId !== group.revisionId\n          );\n          client.revisionIds.push(revision.id);\n        }\n        this._clientGroups.set(group.revisionId, group);\n        logger?.point('serialize_start');\n        // NOTE(EvanBacon): This is the patch\n        const moduleIdContext = {\n          // TODO(@kitten): Increase type-safety here\n          platform: revision.graph.transformOptions.platform!,\n          environment: revision.graph.transformOptions.customTransformOptions?.environment,\n        };\n        const hmrUpdate = hmrJSBundle(delta, revision.graph, {\n          clientUrl: group.clientUrl,\n          // NOTE(EvanBacon): This is also the patch\n          createModuleId: (moduleId: string) => {\n            return this._createModuleId(moduleId, moduleIdContext);\n          },\n          includeAsyncPaths: group.graphOptions.lazy,\n          projectRoot: this._config.projectRoot,\n          serverRoot: this._config.server.unstable_serverRoot ?? this._config.projectRoot,\n        });\n        logger?.point('serialize_end');\n        return {\n          type: 'update',\n          body: {\n            revisionId: revision.id,\n            isInitialUpdate: options.isInitialUpdate,\n            ...hmrUpdate,\n          },\n        };\n      } catch (error: any) {\n        const formattedError = formatBundlingError(error);\n        this._config.reporter.update({\n          type: 'bundling_error',\n          error,\n        });\n        return {\n          type: 'error',\n          body: formattedError,\n        };\n      }\n    };\n  }\n\n  return {\n    metro,\n    hmrServer,\n    server,\n    middleware,\n    messageSocket: messagesSocket,\n  };\n}\n\n// TODO: Fork the entire transform function so we can simply regex the file contents for keywords instead.\nfunction pruneCustomTransformOptions(\n  projectRoot: string,\n  filePath: string,\n  transformOptions: TransformOptions\n): TransformOptions {\n  // Normalize the filepath for cross platform checking.\n  filePath = filePath.split(path.sep).join('/');\n\n  if (\n    transformOptions.customTransformOptions?.dom &&\n    // The only generated file that needs the dom root is `expo/dom/entry.js`\n    !filePath.match(/expo\\/dom\\/entry\\.js$/)\n  ) {\n    // Clear the dom root option if we aren't transforming the magic entry file, this ensures\n    // that cached artifacts from other DOM component bundles can be reused.\n    transformOptions.customTransformOptions.dom = 'true';\n  }\n\n  const routerRoot = transformOptions.customTransformOptions?.routerRoot;\n  if (typeof routerRoot === 'string') {\n    const isRouterEntry = /\\/expo-router\\/_ctx/.test(filePath);\n    // The router root is used all over expo-router (`process.env.EXPO_ROUTER_ABS_APP_ROOT`, `process.env.EXPO_ROUTER_APP_ROOT`) so we'll just ignore the entire package.\n    const isRouterModule = /\\/expo-router\\/build\\//.test(filePath);\n    // Any page/router inside the expo-router app folder may access the `routerRoot` option to determine whether it's in the app folder\n    const resolvedRouterRoot = path.resolve(projectRoot, routerRoot).split(path.sep).join('/');\n    const isRouterRoute = path.isAbsolute(filePath) && filePath.startsWith(resolvedRouterRoot);\n\n    // In any other file than the above, we enforce that we mustn't use `routerRoot`, and set it to an arbitrary value here (the default)\n    // to ensure that the cache never invalidates when this value is changed\n    if (!isRouterEntry && !isRouterModule && !isRouterRoute) {\n      transformOptions.customTransformOptions!.routerRoot = 'app';\n    }\n  }\n\n  if (\n    transformOptions.customTransformOptions?.asyncRoutes &&\n    // The async routes settings are also used in `expo-router/_ctx.ios.js` (and other platform variants) via `process.env.EXPO_ROUTER_IMPORT_MODE`\n    !(filePath.match(/\\/expo-router\\/_ctx/) || filePath.match(/\\/expo-router\\/build\\//))\n  ) {\n    delete transformOptions.customTransformOptions.asyncRoutes;\n  }\n\n  if (\n    transformOptions.customTransformOptions?.clientBoundaries &&\n    // The client boundaries are only used in `expo/virtual/rsc.js` for production RSC exports.\n    !filePath.match(/\\/expo\\/virtual\\/rsc\\.js$/)\n  ) {\n    delete transformOptions.customTransformOptions.clientBoundaries;\n  }\n\n  return transformOptions;\n}\n\n/**\n * Simplify and communicate if Metro is running without watching file updates,.\n * Exposed for testing.\n */\nexport function isWatchEnabled() {\n  if (env.CI) {\n    Log.log(\n      chalk`Metro is running in CI mode, reloads are disabled. Remove {bold CI=true} to enable watch mode.`\n    );\n  }\n\n  return !env.CI;\n}\n"],"names":["event","instantiateMetroAsync","isWatchEnabled","loadMetroConfigAsync","events","t","asWritable","input","LogRespectingTerminal","Terminal","constructor","stream","ttyPrint","sendLog","msg","length","log","format","args","flush","console","info","terminal","process","stdout","projectRoot","options","exp","isExporting","getMetroBundler","config","reportEvent","serverRoot","getMetroServerRoot","isWorkspace","autolinkingModuleResolutionEnabled","experiments","autolinkingModuleResolution","serverActionsEnabled","reactServerFunctions","env","EXPO_UNSTABLE_SERVER_FUNCTIONS","serverComponentsEnabled","reactServerComponentRoutes","EXPO_USE_METRO_REQUIRE","reactCanary","Log","warn","terminalReporter","MetroTerminalReporter","configPath","EXPO_OVERRIDE_METRO_CONFIG","undefined","resolvedConfig","resolveConfig","defaultConfig","getDefaultConfig","isEmpty","mergeConfig","resetCache","maxWorkers","server","port","watchFolders","includes","reporter","update","resolver","useWatchman","globalThis","__requireCycleIgnorePatterns","requireCycleIgnorePatterns","transformer","publicPath","baseUrl","platformBundlers","getPlatformBundlers","reduceLogs","shouldReduceLogs","reactCompilerEnabled","reactCompiler","chalk","gray","EXPO_UNSTABLE_TREE_SHAKING","EXPO_UNSTABLE_METRO_OPTIMIZE_GRAPH","CommandError","EXPO_UNSTABLE_LOG_BOX","withMetroMultiPlatformAsync","isTsconfigPathsEnabled","tsconfigPaths","isAutolinkingResolverEnabled","isNamedRequiresEnabled","isReactServerComponentsEnabled","path","exporting","flags","serverActions","serverComponents","optimizeGraph","treeshaking","logbox","setEventReporter","logger","metroBundler","getConfig","skipSDKVersionRequirement","metroConfig","metro","getBundler","middleware","messagesSocket","eventsSocket","websocketEndpoints","createMetroMiddleware","serverBaseUrl","getUrlCreator","constructUrl","scheme","hostType","prependMiddleware","createCorsMiddleware","debugMiddleware","debugWebsocketEndpoints","createDebugMiddleware","Object","assign","use","createJsInspectorMiddleware","customEnhanceMiddleware","enhanceMiddleware","metroMiddleware","devtoolsWebsocketEndpoints","createDevToolsPluginWebsocketEndpoint","attachAtlasAsync","resetAtlasFile","tls","secureServerOptions","key","cert","ca","requestCert","address","hmrServer","runServer","host","watch","mockServer","atlas","EXPO_ATLAS","workers","originalTransformFile","transformFile","bind","filePath","transformOptions","fileBuffer","pruneCustomTransformOptions","customTransformOptions","__proto__","reportMetroEvent","_getSortedModules","graph","modules","dependencies","values","ctx","platform","environment","module","_createModuleId","sort","a","b","hmrJSBundle","require","default","_prepareMessage","group","changeEvent","isInitialUpdate","revision","revPromise","_bundler","getRevision","revisionId","type","body","formatBundlingError","RevisionNotFoundError","point","delta","updateGraph","_clientGroups","delete","id","client","clients","revisionIds","filter","push","set","moduleIdContext","hmrUpdate","clientUrl","createModuleId","moduleId","includeAsyncPaths","graphOptions","lazy","_config","unstable_serverRoot","error","formattedError","messageSocket","split","sep","join","dom","match","routerRoot","isRouterEntry","test","isRouterModule","resolvedRouterRoot","resolve","isRouterRoute","isAbsolute","startsWith","asyncRoutes","clientBoundaries","CI"],"mappings":"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"}