{"version":3,"sources":["../../../../src/api/user/expoSsoLauncher.ts"],"sourcesContent":["import assert from 'assert';\nimport openBrowserAsync from 'better-opn';\nimport http from 'http';\nimport { Socket } from 'node:net';\nimport querystring from 'querystring';\n\nimport * as Log from '../../log';\n\nexport async function getSessionUsingBrowserAuthFlowAsync({\n  expoWebsiteUrl,\n  sso = false,\n}: {\n  expoWebsiteUrl: string;\n  sso?: boolean;\n}): Promise<string> {\n  const scheme = 'http';\n  const hostname = 'localhost';\n  const path = '/auth/callback';\n\n  const buildExpoLoginUrl = (port: number, sso: boolean): string => {\n    const params = querystring.stringify({\n      confirm_account: 'true',\n      app_redirect_uri: `${scheme}://${hostname}:${port}${path}`,\n    });\n    return `${expoWebsiteUrl}${sso ? '/sso-login' : '/login'}?${params}`;\n  };\n\n  // Start server and begin auth flow\n  const executeAuthFlow = (): Promise<string> => {\n    return new Promise<string>(async (resolve, reject) => {\n      const connections = new Set<Socket>();\n\n      const server = http.createServer(\n        (request: http.IncomingMessage, response: http.ServerResponse) => {\n          const redirectAndCleanup = (result: 'success' | 'error'): void => {\n            const redirectUrl = `${expoWebsiteUrl}/oauth/expo-cli?result=${result}`;\n            response.writeHead(302, { Location: redirectUrl });\n            response.end();\n            server.close();\n            for (const connection of connections) {\n              connection.destroy();\n            }\n          };\n\n          try {\n            if (!(request.method === 'GET' && request.url?.includes('/auth/callback'))) {\n              throw new Error('Unexpected login response.');\n            }\n            const url = new URL(request.url, `http:${request.headers.host}`);\n            const sessionSecret = url.searchParams.get('session_secret');\n\n            if (!sessionSecret) {\n              throw new Error('Request missing session_secret search parameter.');\n            }\n            resolve(sessionSecret);\n            redirectAndCleanup('success');\n          } catch (error) {\n            redirectAndCleanup('error');\n            reject(error);\n          }\n        }\n      );\n\n      server.listen(0, hostname, () => {\n        Log.log('Waiting for browser login...');\n\n        const address = server.address();\n        assert(\n          address !== null && typeof address === 'object',\n          'Server address and port should be set after listening has begun'\n        );\n        const port = address.port;\n        const authorizeUrl = buildExpoLoginUrl(port, sso);\n        openBrowserAsync(authorizeUrl);\n      });\n\n      server.on('connection', (connection) => {\n        connections.add(connection);\n\n        connection.on('close', () => {\n          connections.delete(connection);\n        });\n      });\n    });\n  };\n\n  return await executeAuthFlow();\n}\n"],"names":["getSessionUsingBrowserAuthFlowAsync","expoWebsiteUrl","sso","scheme","hostname","path","buildExpoLoginUrl","port","params","querystring","stringify","confirm_account","app_redirect_uri","executeAuthFlow","Promise","resolve","reject","connections","Set","server","http","createServer","request","response","redirectAndCleanup","result","redirectUrl","writeHead","Location","end","close","connection","destroy","method","url","includes","Error","URL","headers","host","sessionSecret","searchParams","get","error","listen","Log","log","address","assert","authorizeUrl","openBrowserAsync","on","add","delete"],"mappings":";;;;+BAQsBA;;;eAAAA;;;;gEARH;;;;;;;gEACU;;;;;;;gEACZ;;;;;;;gEAEO;;;;;;6DAEH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEd,eAAeA,oCAAoC,EACxDC,cAAc,EACdC,MAAM,KAAK,EAIZ;IACC,MAAMC,SAAS;IACf,MAAMC,WAAW;IACjB,MAAMC,OAAO;IAEb,MAAMC,oBAAoB,CAACC,MAAcL;QACvC,MAAMM,SAASC,sBAAW,CAACC,SAAS,CAAC;YACnCC,iBAAiB;YACjBC,kBAAkB,GAAGT,OAAO,GAAG,EAAEC,SAAS,CAAC,EAAEG,OAAOF,MAAM;QAC5D;QACA,OAAO,GAAGJ,iBAAiBC,MAAM,eAAe,SAAS,CAAC,EAAEM,QAAQ;IACtE;IAEA,mCAAmC;IACnC,MAAMK,kBAAkB;QACtB,OAAO,IAAIC,QAAgB,OAAOC,SAASC;YACzC,MAAMC,cAAc,IAAIC;YAExB,MAAMC,SAASC,eAAI,CAACC,YAAY,CAC9B,CAACC,SAA+BC;gBAC9B,MAAMC,qBAAqB,CAACC;oBAC1B,MAAMC,cAAc,GAAGzB,eAAe,uBAAuB,EAAEwB,QAAQ;oBACvEF,SAASI,SAAS,CAAC,KAAK;wBAAEC,UAAUF;oBAAY;oBAChDH,SAASM,GAAG;oBACZV,OAAOW,KAAK;oBACZ,KAAK,MAAMC,cAAcd,YAAa;wBACpCc,WAAWC,OAAO;oBACpB;gBACF;gBAEA,IAAI;wBACgCV;oBAAlC,IAAI,CAAEA,CAAAA,QAAQW,MAAM,KAAK,WAASX,eAAAA,QAAQY,GAAG,qBAAXZ,aAAaa,QAAQ,CAAC,kBAAgB,GAAI;wBAC1E,MAAM,IAAIC,MAAM;oBAClB;oBACA,MAAMF,MAAM,IAAIG,IAAIf,QAAQY,GAAG,EAAE,CAAC,KAAK,EAAEZ,QAAQgB,OAAO,CAACC,IAAI,EAAE;oBAC/D,MAAMC,gBAAgBN,IAAIO,YAAY,CAACC,GAAG,CAAC;oBAE3C,IAAI,CAACF,eAAe;wBAClB,MAAM,IAAIJ,MAAM;oBAClB;oBACArB,QAAQyB;oBACRhB,mBAAmB;gBACrB,EAAE,OAAOmB,OAAO;oBACdnB,mBAAmB;oBACnBR,OAAO2B;gBACT;YACF;YAGFxB,OAAOyB,MAAM,CAAC,GAAGxC,UAAU;gBACzByC,KAAIC,GAAG,CAAC;gBAER,MAAMC,UAAU5B,OAAO4B,OAAO;gBAC9BC,IAAAA,iBAAM,EACJD,YAAY,QAAQ,OAAOA,YAAY,UACvC;gBAEF,MAAMxC,OAAOwC,QAAQxC,IAAI;gBACzB,MAAM0C,eAAe3C,kBAAkBC,MAAML;gBAC7CgD,IAAAA,oBAAgB,EAACD;YACnB;YAEA9B,OAAOgC,EAAE,CAAC,cAAc,CAACpB;gBACvBd,YAAYmC,GAAG,CAACrB;gBAEhBA,WAAWoB,EAAE,CAAC,SAAS;oBACrBlC,YAAYoC,MAAM,CAACtB;gBACrB;YACF;QACF;IACF;IAEA,OAAO,MAAMlB;AACf"}