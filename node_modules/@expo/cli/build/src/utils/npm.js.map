{"version":3,"sources":["../../../src/utils/npm.ts"],"sourcesContent":["import { IOSConfig } from '@expo/config-plugins';\nimport { JSONValue } from '@expo/json-file';\nimport spawnAsync from '@expo/spawn-async';\nimport { TarTypeFlag } from 'multitars';\nimport assert from 'node:assert';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport slugify from 'slugify';\nimport { Readable } from 'stream';\n\nimport { CommandError } from './errors';\nimport { extractStream } from './tar';\n\nconst debug = require('debug')('expo:utils:npm') as typeof console.log;\n\nexport function sanitizeNpmPackageName(name: string): string {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n  return (\n    applyKnownNpmPackageNameRules(name) ||\n    applyKnownNpmPackageNameRules(slugify(name)) ||\n    // If nothing is left use 'app' like we do in Xcode projects.\n    'app'\n  );\n}\n\nfunction applyKnownNpmPackageNameRules(name: string): string | null {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n\n  // package name cannot start with '.' or '_'.\n  while (/^(\\.|_)/.test(name)) {\n    name = name.substring(1);\n  }\n\n  name = name.toLowerCase().replace(/[^a-zA-Z._\\-/@]/g, '');\n\n  return (\n    name\n      // .replace(/![a-z0-9-._~]+/g, '')\n      // Remove special characters\n      .normalize('NFD')\n      .replace(/[\\u0300-\\u036f]/g, '') || null\n  );\n}\n\nexport async function npmViewAsync(...props: string[]): Promise<JSONValue> {\n  const cmd = ['view', ...props, '--json'];\n  const results = (await spawnAsync('npm', cmd)).stdout?.trim();\n  const cmdString = `npm ${cmd.join(' ')}`;\n  debug('Run:', cmdString);\n  if (!results) {\n    return null;\n  }\n  try {\n    return JSON.parse(results);\n  } catch (error: any) {\n    throw new Error(\n      `Could not parse JSON returned from \"${cmdString}\".\\n\\n${results}\\n\\nError: ${error.message}`\n    );\n  }\n}\n\n/** Given a package name like `expo` or `expo@beta`, return the registry URL if it exists. */\nexport async function getNpmUrlAsync(packageName: string): Promise<string> {\n  const results = await npmViewAsync(packageName, 'dist');\n\n  assert(results, `Could not get npm url for package \"${packageName}\"`);\n\n  // Fully qualified url returns an object.\n  // Example:\n  // ð  npm view expo-template-bare-minimum@sdk-33 dist --json\n  if (typeof results === 'object' && !Array.isArray(results)) {\n    return results.tarball as string;\n  }\n\n  // When the tag is arbitrary, the tarball is an array, return the last value as it's the most recent.\n  // Example:\n  // ð  npm view expo-template-bare-minimum@33 dist --json\n  if (Array.isArray(results)) {\n    const lastResult = results[results.length - 1];\n\n    if (lastResult && typeof lastResult === 'object' && !Array.isArray(lastResult)) {\n      return lastResult.tarball as string;\n    }\n  }\n\n  throw new CommandError(\n    'Expected results of `npm view ...` to be an array or string. Instead found: ' + results\n  );\n}\n\nexport interface ExtractProps {\n  expName?: string;\n  filter?(path: string): boolean | undefined | null;\n  strip?: number;\n}\n\nfunction renameNpmTarballEntries(expName: string | undefined) {\n  const renameConfigs = (input: string, typeflag: TarTypeFlag): string | null => {\n    if (typeflag === TarTypeFlag.FILE && path.basename(input) === 'gitignore') {\n      // Rename `gitignore` because npm ignores files named `.gitignore` when publishing.\n      // See: https://github.com/npm/npm/issues/1862\n      return input.replace(/gitignore$/, '.gitignore');\n    } else {\n      return input;\n    }\n  };\n  if (expName) {\n    const androidName = IOSConfig.XcodeUtils.sanitizedName(expName.toLowerCase());\n    const iosName = IOSConfig.XcodeUtils.sanitizedName(expName);\n    const lowerCaseName = iosName.toLowerCase();\n    return (input: string, typeflag: TarTypeFlag) => {\n      input = input\n        .replace(/HelloWorld/g, input.includes('android') ? androidName : iosName)\n        .replace(/helloworld/g, lowerCaseName);\n      return renameConfigs(input, typeflag);\n    };\n  } else {\n    return renameConfigs;\n  }\n}\n\n/**\n * Extracts a tarball stream to a directory and returns the checksum of the tarball.\n */\nexport async function extractNpmTarballAsync(\n  stream: ReadableStream,\n  output: string,\n  props: ExtractProps\n): Promise<string> {\n  return await extractStream(stream, output, {\n    filter: props.filter,\n    rename: renameNpmTarballEntries(props.expName),\n    strip: props.strip ?? 1,\n  });\n}\n\nexport async function extractNpmTarballFromUrlAsync(\n  url: string,\n  output: string,\n  props: ExtractProps\n): Promise<string> {\n  const response = await fetch(url);\n  if (!response.ok || !response.body) {\n    throw new Error(`Unexpected response: ${response.statusText}. From url: ${url}`);\n  }\n  return await extractNpmTarballAsync(response.body, output, props);\n}\n\nexport async function downloadAndExtractNpmModuleAsync(\n  npmName: string,\n  output: string,\n  props: ExtractProps\n): Promise<string> {\n  const url = await getNpmUrlAsync(npmName);\n  debug('Fetch from URL:', url);\n  return await extractNpmTarballFromUrlAsync(url, output, props);\n}\n\nexport async function extractLocalNpmTarballAsync(\n  tarFilePath: string,\n  output: string,\n  props: ExtractProps\n): Promise<string> {\n  return await extractNpmTarballAsync(\n    Readable.toWeb(fs.createReadStream(tarFilePath)) as ReadableStream,\n    output,\n    props\n  );\n}\n\nexport async function packNpmTarballAsync(packageDir: string): Promise<string> {\n  const cmdArgs = ['pack', '--json', '--foreground-scripts=false'];\n  const results = (\n    await spawnAsync('npm', cmdArgs, {\n      env: { ...process.env },\n      cwd: packageDir,\n    })\n  ).stdout?.trim();\n  try {\n    const [json] = JSON.parse(results) as { filename: string }[];\n    return path.resolve(packageDir, json.filename);\n  } catch (error: any) {\n    const cmdString = `npm ${cmdArgs.join(' ')}`;\n    throw new Error(\n      `Could not parse JSON returned from \"${cmdString}\".\\n\\n${results}\\n\\nError: ${error.message}`\n    );\n  }\n}\n"],"names":["downloadAndExtractNpmModuleAsync","extractLocalNpmTarballAsync","extractNpmTarballAsync","extractNpmTarballFromUrlAsync","getNpmUrlAsync","npmViewAsync","packNpmTarballAsync","sanitizeNpmPackageName","debug","require","name","applyKnownNpmPackageNameRules","slugify","test","substring","toLowerCase","replace","normalize","props","cmd","results","spawnAsync","stdout","trim","cmdString","join","JSON","parse","error","Error","message","packageName","assert","Array","isArray","tarball","lastResult","length","CommandError","renameNpmTarballEntries","expName","renameConfigs","input","typeflag","TarTypeFlag","FILE","path","basename","androidName","IOSConfig","XcodeUtils","sanitizedName","iosName","lowerCaseName","includes","stream","output","extractStream","filter","rename","strip","url","response","fetch","ok","body","statusText","npmName","tarFilePath","Readable","toWeb","fs","createReadStream","packageDir","cmdArgs","env","process","cwd","json","resolve","filename"],"mappings":"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"}