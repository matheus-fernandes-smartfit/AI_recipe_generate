{"version":3,"sources":["../../../src/utils/tar.ts"],"sourcesContent":["import { streamToAsyncIterable, TarTypeFlag, untar } from 'multitars';\nimport crypto from 'node:crypto';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport { Readable } from 'node:stream';\n\nimport { ensureDirectoryAsync } from './dir';\n\nconst debug = require('debug')('expo:utils:tar') as typeof console.log;\n\nclass ChecksumStream extends TransformStream {\n  hash: crypto.Hash;\n  constructor(algorithm: string) {\n    super({\n      transform: (chunk, controller) => {\n        this.hash.update(chunk);\n        controller.enqueue(chunk);\n      },\n    });\n    this.hash = crypto.createHash(algorithm);\n  }\n\n  digest(): Buffer;\n  digest(encoding: crypto.BinaryToTextEncoding): string;\n  digest(encoding?: crypto.BinaryToTextEncoding): string | Buffer {\n    return this.hash.digest(encoding!);\n  }\n}\n\nexport interface ExtractOptions {\n  strip?: number;\n  filter?(name: string, type: TarTypeFlag): boolean | null | undefined;\n  rename?(name: string, type: TarTypeFlag): string | null | undefined;\n  checksumAlgorithm?: string;\n}\n\nexport async function extractStream(\n  input: ReadableStream,\n  output: string,\n  options: ExtractOptions = {}\n): Promise<string> {\n  output = path.resolve(output);\n  await ensureDirectoryAsync(output);\n\n  const { checksumAlgorithm, strip = 0, rename, filter } = options;\n\n  const checksumStream = new ChecksumStream(checksumAlgorithm || 'md5');\n  const decompressionStream = new DecompressionStream('gzip');\n\n  const body = input.pipeThrough(checksumStream).pipeThrough(decompressionStream);\n\n  for await (const file of untar(body)) {\n    let name = path.normalize(file.name);\n    if (filter && !filter(name, file.typeflag)) {\n      debug(`filtered: ${path.resolve(output, name)}`);\n      continue;\n    } else if (rename) {\n      name = rename(name, file.typeflag) ?? name;\n    }\n\n    for (let idx = 0; idx < strip; idx++) {\n      const sepIdx = name.indexOf(path.sep);\n      if (sepIdx > -1) {\n        name = name.slice(sepIdx + 1);\n      } else {\n        break;\n      }\n    }\n\n    const resolved = path.resolve(output, name);\n    if (!resolved.startsWith(output)) {\n      debug(`skip: ${resolved}`);\n      continue;\n    }\n\n    const parent = path.dirname(resolved);\n    if (parent !== output) {\n      let exists = false;\n      try {\n        const stat = await fs.promises.lstat(parent);\n        if (stat.isSymbolicLink() || (!stat.isDirectory() && !stat.isFile())) {\n          debug(`skip: ${resolved}`);\n          continue;\n        } else if (stat.isDirectory()) {\n          exists = true;\n        }\n      } catch {}\n\n      if (!exists) {\n        debug(`mkdir(p): ${parent}`);\n        await fs.promises.mkdir(parent, { recursive: true });\n      }\n    }\n\n    switch (file.typeflag) {\n      case TarTypeFlag.FILE:\n        debug(`write(${file.mode.toString(8)}): ${resolved}`);\n        await fs.promises.writeFile(resolved, streamToAsyncIterable(file.stream()), {\n          mode: file.mode,\n        });\n        break;\n      case TarTypeFlag.DIRECTORY:\n        debug(`mkdir(${file.mode.toString(8)}): ${resolved}`);\n        try {\n          await fs.promises.mkdir(resolved, { mode: file.mode });\n        } catch (error: any) {\n          if (error.code !== 'EEXIST') {\n            throw error;\n          }\n        }\n        break;\n      case TarTypeFlag.SYMLINK:\n      case TarTypeFlag.LINK: {\n        const target = path.resolve(parent, file.linkname ?? '');\n        if (!target.startsWith(output) || target === parent) {\n          debug(`skip: ${resolved} -> ${target}`);\n          continue;\n        }\n\n        if (file.typeflag === TarTypeFlag.LINK) {\n          debug(`link: ${resolved} -> ${target}`);\n          await fs.promises.link(target, resolved);\n        } else {\n          const stat = await fs.promises.lstat(target).catch(() => null);\n          const type = stat?.isDirectory() ? 'dir' : 'file';\n          debug(`symlink(${type}): ${resolved} -> ${target}`);\n          await fs.promises.symlink(target, resolved, type);\n        }\n        break;\n      }\n    }\n  }\n\n  return checksumStream.digest('hex');\n}\n\n/** Extract a tar using built-in tools if available and falling back on Node.js. */\nexport async function extractAsync(\n  input: string,\n  output: string,\n  options?: ExtractOptions\n): Promise<void> {\n  await extractStream(\n    Readable.toWeb(fs.createReadStream(input)) as ReadableStream,\n    output,\n    options\n  );\n}\n"],"names":["extractAsync","extractStream","debug","require","ChecksumStream","TransformStream","constructor","algorithm","transform","chunk","controller","hash","update","enqueue","crypto","createHash","digest","encoding","input","output","options","path","resolve","ensureDirectoryAsync","checksumAlgorithm","strip","rename","filter","checksumStream","decompressionStream","DecompressionStream","body","pipeThrough","file","untar","name","normalize","typeflag","idx","sepIdx","indexOf","sep","slice","resolved","startsWith","parent","dirname","exists","stat","fs","promises","lstat","isSymbolicLink","isDirectory","isFile","mkdir","recursive","TarTypeFlag","FILE","mode","toString","writeFile","streamToAsyncIterable","stream","DIRECTORY","error","code","SYMLINK","LINK","target","linkname","link","catch","type","symlink","Readable","toWeb","createReadStream"],"mappings":"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"}