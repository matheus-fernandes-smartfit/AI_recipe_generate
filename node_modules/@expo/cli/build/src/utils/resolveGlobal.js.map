{"version":3,"sources":["../../../src/utils/resolveGlobal.ts"],"sourcesContent":["// NOTE: This file is replicated to multiple packages! Keep these files in-sync:\n// - packages/@expo/cli/src/utils/resolveGlobal.ts\n// - packages/@expo/image-utils/src/resolveGlobal.ts\n\nimport { spawnSync } from 'child_process';\nimport fs from 'fs';\nimport Module from 'module';\nimport os from 'os';\nimport path from 'path';\n\ndeclare module 'module' {\n  namespace Module {\n    const globalPaths: readonly string[] | void;\n  }\n}\n\nconst memoize = <Args extends any[], T>(fn: (...args: Args) => T): ((...args: Args) => T) => {\n  let result: { value: T } | undefined;\n  return (...args: Args): T => {\n    if (result === undefined) {\n      result = { value: fn(...args) };\n    }\n    return result.value;\n  };\n};\n\nconst isWindows = process.platform === 'win32';\n\nconst getDelimitedPaths = (delimited: string): string[] =>\n  delimited\n    .split(path.delimiter)\n    .map((target) => {\n      try {\n        const normalized = path.normalize(target.trim());\n        if (!normalized) {\n          return null;\n        } else if (!path.isAbsolute(normalized)) {\n          return path.resolve(process.cwd(), normalized);\n        } else {\n          return normalized;\n        }\n      } catch {\n        return null;\n      }\n    })\n    .filter((target): target is string => !!target);\n\nconst execGetPaths = (cmd: string, args: string[]): string[] => {\n  const result = spawnSync(cmd, args, { encoding: 'utf8' });\n  if (!result.error && result.status === 0 && result.stdout) {\n    const paths = getDelimitedPaths(result.stdout.replace(/[\\r\\n]+/g, path.delimiter));\n    return paths.filter((target) => fs.existsSync(target));\n  }\n  return [];\n};\n\nconst getNativeNodePaths = () => {\n  if (Array.isArray(Module.globalPaths)) {\n    return Module.globalPaths;\n  } else {\n    return [];\n  }\n};\n\nconst getHomePath = memoize(() => {\n  try {\n    return os.homedir();\n  } catch {\n    return isWindows ? (process.env.UserProfile ?? process.env.USERPROFILE) : process.env.HOME;\n  }\n});\n\nconst getNpmDefaultPaths = () => {\n  const prefix = [];\n  const localAppData = process.env.LocalAppData || process.env.LOCALAPPDATA;\n  if (isWindows && localAppData) {\n    prefix.push(path.resolve(localAppData, 'npm'));\n  } else if (!isWindows) {\n    prefix.push('/usr/local/lib/node_modules');\n  }\n  return prefix.filter((target) => fs.existsSync(target));\n};\n\nconst getNpmPrefixPaths = memoize(() => {\n  const npmPrefix = execGetPaths(isWindows ? 'npm.cmd' : 'npm', ['config', '-g', 'get', 'prefix']);\n  return npmPrefix.map((prefix) => path.resolve(prefix, 'lib'));\n});\n\nconst getYarnDefaultPaths = () => {\n  const prefix = [];\n  const homePath = getHomePath();\n  const localAppData = process.env.LocalAppData || process.env.LOCALAPPDATA;\n  const dataHomePath =\n    process.env.XDG_DATA_HOME || (homePath && path.join(homePath, '.local', 'share'));\n  if (isWindows && localAppData) {\n    prefix.push(path.resolve(localAppData, 'Yarn', 'global'));\n  }\n  if (dataHomePath) {\n    prefix.push(path.resolve(dataHomePath, 'yarn', 'global'));\n  }\n  if (homePath) {\n    prefix.push(path.resolve(homePath, '.yarn', 'global'));\n  }\n  return prefix.filter((target) => fs.existsSync(target));\n};\n\nconst getYarnPrefixPaths = memoize(() => {\n  return execGetPaths(isWindows ? 'yarn.cmd' : 'yarn', ['global', 'dir']);\n});\n\nconst getPnpmPrefixPaths = memoize(() => {\n  return execGetPaths(isWindows ? 'pnpm.cmd' : 'pnpm', ['root', '-g']);\n});\n\nconst getBunPrefixPaths = memoize(() => {\n  const prefix = [];\n  const bunPath = execGetPaths(isWindows ? 'bun.cmd' : 'bun', ['pm', 'bin', '-g'])[0];\n  if (!bunPath) {\n    return [];\n  }\n  prefix.push(path.resolve(bunPath, 'global'));\n  const moduleEntry = fs.readdirSync(bunPath, { withFileTypes: true }).find((entry) => {\n    return entry.isSymbolicLink() && entry.name !== 'global';\n  });\n  if (moduleEntry) {\n    try {\n      const moduleTarget = fs.realpathSync(path.resolve(bunPath, moduleEntry.name));\n      const splitIdx = moduleTarget.indexOf(path.sep + 'node_modules' + path.sep);\n      if (splitIdx > -1) {\n        const modulePath = moduleTarget.slice(0, splitIdx);\n        prefix.push(modulePath);\n      }\n    } catch {}\n  }\n  return prefix.filter((target) => fs.existsSync(target));\n});\n\nconst getPaths = () => [\n  ...getNpmDefaultPaths(),\n  ...getNpmPrefixPaths(),\n  ...getYarnDefaultPaths(),\n  ...getYarnPrefixPaths(),\n  ...getPnpmPrefixPaths(),\n  ...getBunPrefixPaths(),\n  ...getNativeNodePaths(),\n  process.cwd(),\n];\n\n/** Resolve a globally installed module before a locally installed one */\nexport const resolveGlobal = (id: string): string => {\n  return require.resolve(id, { paths: getPaths() });\n};\n"],"names":["resolveGlobal","memoize","fn","result","args","undefined","value","isWindows","process","platform","getDelimitedPaths","delimited","split","path","delimiter","map","target","normalized","normalize","trim","isAbsolute","resolve","cwd","filter","execGetPaths","cmd","spawnSync","encoding","error","status","stdout","paths","replace","fs","existsSync","getNativeNodePaths","Array","isArray","Module","globalPaths","getHomePath","os","homedir","env","UserProfile","USERPROFILE","HOME","getNpmDefaultPaths","prefix","localAppData","LocalAppData","LOCALAPPDATA","push","getNpmPrefixPaths","npmPrefix","getYarnDefaultPaths","homePath","dataHomePath","XDG_DATA_HOME","join","getYarnPrefixPaths","getPnpmPrefixPaths","getBunPrefixPaths","bunPath","moduleEntry","readdirSync","withFileTypes","find","entry","isSymbolicLink","name","moduleTarget","realpathSync","splitIdx","indexOf","sep","modulePath","slice","getPaths","id","require"],"mappings":"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"}