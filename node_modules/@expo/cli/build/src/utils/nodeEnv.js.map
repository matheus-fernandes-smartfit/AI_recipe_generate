{"version":3,"sources":["../../../src/utils/nodeEnv.ts"],"sourcesContent":["import * as env from '@expo/env';\nimport path from 'node:path';\n\nimport { events, shouldReduceLogs } from '../events';\n\ntype EnvOutput = Record<string, string | undefined>;\n\n// TODO(@kitten): We assign this here to run server-side code bundled by metro\n// It's not isolated into a worker thread yet\ndeclare namespace globalThis {\n  let __DEV__: boolean | undefined;\n}\n\n// prettier-ignore\nexport const event = events('env', (t) => [\n  t.event<'mode', {\n    nodeEnv: string;\n    babelEnv: string;\n    mode: 'development' | 'production';\n  }>(),\n  t.event<'load', {\n    mode: string | undefined;\n    files: string[];\n    env: Record<string, string | undefined>;\n  }>(),\n]);\n\n/**\n * Set the environment to production or development\n * lots of tools use this to determine if they should run in a dev mode.\n */\nexport function setNodeEnv(mode: 'development' | 'production') {\n  process.env.NODE_ENV = process.env.NODE_ENV || mode;\n  process.env.BABEL_ENV = process.env.BABEL_ENV || process.env.NODE_ENV;\n  globalThis.__DEV__ = process.env.NODE_ENV !== 'production';\n\n  event('mode', {\n    nodeEnv: process.env.NODE_ENV,\n    babelEnv: process.env.BABEL_ENV,\n    mode,\n  });\n}\n\ninterface LoadEnvFilesOptions {\n  force?: boolean;\n  silent?: boolean;\n  mode?: string;\n}\n\nlet prevEnvKeys: Set<string> | undefined;\n\n/**\n * Load the dotenv files into the current `process.env` scope.\n * Note, this requires `NODE_ENV` being set through `setNodeEnv`.\n */\nexport function loadEnvFiles(projectRoot: string, options?: LoadEnvFilesOptions) {\n  const params = {\n    ...options,\n    silent: !!options?.silent || shouldReduceLogs(),\n    force: !!options?.force,\n    mode: process.env.NODE_ENV,\n    systemEnv: process.env,\n  };\n\n  const envInfo = env.loadProjectEnv(projectRoot, params);\n  const envOutput: EnvOutput = {};\n  if (envInfo.result === 'loaded') {\n    prevEnvKeys = new Set();\n    for (const key of envInfo.loaded) {\n      envOutput[key] = envInfo.env[key] ?? undefined;\n      prevEnvKeys.add(key);\n    }\n  }\n\n  if (envInfo.result === 'loaded') {\n    event('load', {\n      mode: params.mode,\n      files: envInfo.files.map((file) => event.path(file)),\n      env: envOutput,\n    });\n  }\n\n  if (!params.silent) {\n    env.logLoadedEnv(envInfo, params);\n  }\n  return process.env;\n}\n\nexport function getEnvFiles(projectRoot: string) {\n  return env\n    .getEnvFiles({ mode: process.env.NODE_ENV })\n    .map((fileName) => path.join(projectRoot, fileName));\n}\n\nexport function reloadEnvFiles(projectRoot: string) {\n  const isEnabled = env.isEnabled();\n  if (isEnabled) {\n    const params = {\n      force: true,\n      silent: true,\n      mode: process.env.NODE_ENV,\n      systemEnv: process.env,\n    };\n\n    // We use a global tracker to allow overwrites of env vars we set ourselves\n    const envInfo = env.parseProjectEnv(projectRoot, params);\n    const envOutput: EnvOutput = {};\n    for (const key in envInfo.env) {\n      const value = envInfo.env[key];\n      if (process.env[key] !== value) {\n        if (\n          typeof process.env[key] === 'undefined' ||\n          ((!prevEnvKeys || prevEnvKeys.has(key)) && process.env[key] !== value)\n        ) {\n          (prevEnvKeys ||= new Set()).add(key);\n          process.env[key] = envInfo.env[key];\n          envOutput[key] = value ?? undefined;\n        }\n      }\n    }\n\n    event('load', {\n      mode: params.mode,\n      files: envInfo.files.map((file) => event.path(file)),\n      env: envOutput,\n    });\n  }\n}\n"],"names":["event","getEnvFiles","loadEnvFiles","reloadEnvFiles","setNodeEnv","events","t","mode","process","env","NODE_ENV","BABEL_ENV","globalThis","__DEV__","nodeEnv","babelEnv","prevEnvKeys","projectRoot","options","params","silent","shouldReduceLogs","force","systemEnv","envInfo","loadProjectEnv","envOutput","result","Set","key","loaded","undefined","add","files","map","file","path","logLoadedEnv","fileName","join","isEnabled","parseProjectEnv","value","has"],"mappings":"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"}