{"version":3,"sources":["../../../src/utils/getRunningProcess.ts"],"sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport * as path from 'path';\n\nconst debug = require('debug')('expo:utils:getRunningProcess') as typeof console.log;\n\n/** Timeout applied to shell commands */\nconst timeout = 350;\n\n/** Returns a pid value for a running port like `63828` or null if nothing is running on the given port. */\nexport async function getPID(port: number): Promise<number | null> {\n  try {\n    const { stdout } = await spawnAsync('lsof', [`-i:${port}`, '-P', '-t', '-sTCP:LISTEN'], {\n      timeout,\n    });\n    const pid = Number(stdout.split('\\n', 1)[0].trim());\n    debug(`pid: ${pid} for port: ${port}`);\n    return Number.isSafeInteger(pid) ? pid : null;\n  } catch (error: any) {\n    debug(`No pid found for port: ${port}. Error: ${error}`);\n    return null;\n  }\n}\n\n/** Get `package.json` `name` field for a given directory. Returns `null` if none exist. */\nfunction getPackageName(packageRoot: string): string | null {\n  try {\n    const packageJson = path.resolve(packageRoot, 'package.json');\n    return require(packageJson).name || null;\n  } catch (error) {\n    return null;\n  }\n}\n\n/** Returns a command like `node /Users/evanbacon/.../bin/expo start` or the package.json name. */\nexport async function getProcessCommand(\n  pid: number,\n  procDirectory: string\n): Promise<string | null> {\n  let name = getPackageName(procDirectory);\n  if (!name) {\n    // ps\n    // -o args=: Output argv without header\n    // -p [pid]: For process of PID\n    const { stdout } = await spawnAsync('ps', ['-o', 'args=', '-p', `${pid}`], {\n      timeout,\n    });\n    name = stdout.trim();\n  }\n  return name || null;\n}\n\n/** Get directory for a given process ID. */\nexport async function getDirectoryOfProcessById(pid: number): Promise<string | null> {\n  try {\n    // lsof\n    // -F n: ask for machine readable output\n    // -a: apply conditions as logical AND\n    // -d cwd: Filter by cwd fd\n    // -p [pid]: Filter by input process id\n    const { stdout } = await spawnAsync('lsof', ['-F', 'n', '-a', '-d', 'cwd', '-p', `${pid}`], {\n      timeout,\n    });\n    const processCWD = stdout\n      .split('\\n')\n      .find((output) => output.startsWith('n'))\n      ?.slice(1);\n    return processCWD && path.isAbsolute(processCWD) ? path.normalize(processCWD) : null;\n  } catch {\n    return null;\n  }\n}\n\ninterface RunningProcess {\n  /** The PID value for the port. */\n  pid: number;\n  /** Get the directory for the running process. */\n  directory: string;\n  /** The command running the process like `node /Users/evanbacon/.../bin/expo start` or the `package.json` name like `my-app`. */\n  command: string;\n}\n\n/** Get information about a running process given a port. Returns null if no process is running on the given port. */\nexport async function getRunningProcess(port: number): Promise<RunningProcess | null> {\n  // Don't even try on Windows, since `lsof` and `ps` are not available there\n  if (process.platform === 'win32') {\n    return null;\n  }\n\n  const pid = await getPID(port);\n  if (!pid) {\n    return null;\n  }\n  try {\n    const directory = await getDirectoryOfProcessById(pid);\n    if (directory) {\n      const command = await getProcessCommand(pid, directory);\n      if (command) {\n        return { pid, directory, command };\n      }\n    }\n  } catch {}\n  return null;\n}\n"],"names":["getDirectoryOfProcessById","getPID","getProcessCommand","getRunningProcess","debug","require","timeout","port","stdout","spawnAsync","pid","Number","split","trim","isSafeInteger","error","getPackageName","packageRoot","packageJson","path","resolve","name","procDirectory","processCWD","find","output","startsWith","slice","isAbsolute","normalize","process","platform","directory","command"],"mappings":";;;;;;;;;;;IAoDsBA,yBAAyB;eAAzBA;;IA3CAC,MAAM;eAANA;;IAyBAC,iBAAiB;eAAjBA;;IAgDAC,iBAAiB;eAAjBA;;;;gEAlFC;;;;;;;iEACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEtB,MAAMC,QAAQC,QAAQ,SAAS;AAE/B,sCAAsC,GACtC,MAAMC,UAAU;AAGT,eAAeL,OAAOM,IAAY;IACvC,IAAI;QACF,MAAM,EAAEC,MAAM,EAAE,GAAG,MAAMC,IAAAA,qBAAU,EAAC,QAAQ;YAAC,CAAC,GAAG,EAAEF,MAAM;YAAE;YAAM;YAAM;SAAe,EAAE;YACtFD;QACF;QACA,MAAMI,MAAMC,OAAOH,OAAOI,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,CAACC,IAAI;QAChDT,MAAM,CAAC,KAAK,EAAEM,IAAI,WAAW,EAAEH,MAAM;QACrC,OAAOI,OAAOG,aAAa,CAACJ,OAAOA,MAAM;IAC3C,EAAE,OAAOK,OAAY;QACnBX,MAAM,CAAC,uBAAuB,EAAEG,KAAK,SAAS,EAAEQ,OAAO;QACvD,OAAO;IACT;AACF;AAEA,yFAAyF,GACzF,SAASC,eAAeC,WAAmB;IACzC,IAAI;QACF,MAAMC,cAAcC,QAAKC,OAAO,CAACH,aAAa;QAC9C,OAAOZ,QAAQa,aAAaG,IAAI,IAAI;IACtC,EAAE,OAAON,OAAO;QACd,OAAO;IACT;AACF;AAGO,eAAeb,kBACpBQ,GAAW,EACXY,aAAqB;IAErB,IAAID,OAAOL,eAAeM;IAC1B,IAAI,CAACD,MAAM;QACT,KAAK;QACL,uCAAuC;QACvC,+BAA+B;QAC/B,MAAM,EAAEb,MAAM,EAAE,GAAG,MAAMC,IAAAA,qBAAU,EAAC,MAAM;YAAC;YAAM;YAAS;YAAM,GAAGC,KAAK;SAAC,EAAE;YACzEJ;QACF;QACAe,OAAOb,OAAOK,IAAI;IACpB;IACA,OAAOQ,QAAQ;AACjB;AAGO,eAAerB,0BAA0BU,GAAW;IACzD,IAAI;YASiBF;QARnB,OAAO;QACP,wCAAwC;QACxC,sCAAsC;QACtC,2BAA2B;QAC3B,uCAAuC;QACvC,MAAM,EAAEA,MAAM,EAAE,GAAG,MAAMC,IAAAA,qBAAU,EAAC,QAAQ;YAAC;YAAM;YAAK;YAAM;YAAM;YAAO;YAAM,GAAGC,KAAK;SAAC,EAAE;YAC1FJ;QACF;QACA,MAAMiB,cAAaf,qBAAAA,OAChBI,KAAK,CAAC,MACNY,IAAI,CAAC,CAACC,SAAWA,OAAOC,UAAU,CAAC,0BAFnBlB,mBAGfmB,KAAK,CAAC;QACV,OAAOJ,cAAcJ,QAAKS,UAAU,CAACL,cAAcJ,QAAKU,SAAS,CAACN,cAAc;IAClF,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAYO,eAAepB,kBAAkBI,IAAY;IAClD,2EAA2E;IAC3E,IAAIuB,QAAQC,QAAQ,KAAK,SAAS;QAChC,OAAO;IACT;IAEA,MAAMrB,MAAM,MAAMT,OAAOM;IACzB,IAAI,CAACG,KAAK;QACR,OAAO;IACT;IACA,IAAI;QACF,MAAMsB,YAAY,MAAMhC,0BAA0BU;QAClD,IAAIsB,WAAW;YACb,MAAMC,UAAU,MAAM/B,kBAAkBQ,KAAKsB;YAC7C,IAAIC,SAAS;gBACX,OAAO;oBAAEvB;oBAAKsB;oBAAWC;gBAAQ;YACnC;QACF;IACF,EAAE,OAAM,CAAC;IACT,OAAO;AACT"}