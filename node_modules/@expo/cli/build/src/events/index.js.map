{"version":3,"sources":["../../../src/events/index.ts"],"sourcesContent":["import { Console } from 'node:console';\nimport path from 'node:path';\nimport { WriteStream } from 'node:tty';\n\nimport type { EventBuilder, EventLoggerBuilder, EventShape } from './builder';\nimport { LogStream } from './stream';\nimport { env } from '../utils/env';\n\ninterface InitMetadata {\n  format: 'v0-jsonl' | (string & {});\n  version: string;\n}\n\nlet logPath = process.cwd();\nlet logStream: LogStream | undefined;\n\nfunction parseLogTarget(env: string | undefined) {\n  let logDestination: string | number | undefined;\n  if (env) {\n    const fd = parseInt(env, 10);\n    if (fd > 0 && Number.isSafeInteger(fd)) {\n      logDestination = fd;\n    } else {\n      try {\n        const parsedPath = path.parse(env);\n        logDestination = path.format(parsedPath);\n        logPath = parsedPath.dir;\n      } catch {\n        logDestination = undefined;\n      }\n    }\n  }\n  return logDestination;\n}\n\nfunction getInitMetadata(): InitMetadata {\n  return {\n    format: 'v0-jsonl',\n    // Version is added in the build script.\n    version: process.env.__EXPO_VERSION ?? 'UNVERSIONED',\n  };\n}\n\n/** Activates the event logger based on the input env var\n * @param env - The target to write the logs to; defaults to `$LOG_EVENTS`\n */\nexport function installEventLogger(env = process.env.LOG_EVENTS) {\n  const eventLogDestination = parseLogTarget(env);\n  if (eventLogDestination) {\n    if (eventLogDestination === 1) {\n      const output = new WriteStream(2);\n      Object.defineProperty(process, 'stdout', { get: () => output });\n      globalThis.console = new Console(output, output);\n    } else if (eventLogDestination === 2) {\n      const output = new WriteStream(1);\n      Object.defineProperty(process, 'stderr', { get: () => output });\n      globalThis.console = new Console(output, output);\n    }\n    logStream = new LogStream(eventLogDestination);\n    rootEvent('init', getInitMetadata());\n  }\n}\n\n/** Returns whether the event logger is active */\nexport const isEventLoggerActive = () => !!logStream?.writable;\n\n/** Whether logs shown in the terminal should be reduced.\n * @remarks\n * We indicate that we're in an automated tool (e.g. E2E tests) with `EXPO_UNSTABLE_HEADLESS`.\n * If the event logger is activate and we're running in a headless tool, we should reduce\n * interactive or noisy logs, in favour of the event logger.\n */\nexport const shouldReduceLogs = () => !!logStream && env.EXPO_UNSTABLE_HEADLESS;\n\n/** Used to create an event logger for structured JSONL logs activated with the `LOG_EVENTS` environment variable.\n *\n * @remarks\n * Structured logs are streamed to a JSONL output file or file descriptor, and are meant for automated tooling\n * or normal usage to document what happened during a user session. When creating a module that outputs errors,\n * events, or captures what the user was doing, create a new event logger category for them and add structured\n * log events.\n * For example, `../start/server/metro/MetroTerminalReporter` captures most of Metro's logged events.\n * Structured JSONL logs don't have a large performance impact, unlike `DEBUG` logs, and are easily parseable\n * and filterable, including by wrapper processes.\n *\n * After adding a new event category, don't forget to add it to `./types.ts` to collect all event shape types\n * in one place.\n *\n * @example\n * ```ts\n * export const event = events('test', (t) => [\n *   t.event<'my_event', {\n *     myValue: string | null;\n *   }>(),\n * ]);\n *\n * event('my_event', { myValue: 'test' });\n * ```\n *\n * This will log a `{ _e: 'test:my_event', _t: 0, myValue: 'test' }` entry in the event log.\n */\nexport const events: EventLoggerBuilder = ((\n  category: string,\n  _fn: (builder: EventBuilder) => readonly EventShape<string>[]\n) => {\n  function log(event: string, data: any) {\n    if (logStream) {\n      const _e = `${category}:${String(event)}`;\n      const _t = Date.now();\n      const payload = JSON.stringify({ _e, _t, ...data });\n      logStream._write(payload + '\\n');\n    }\n  }\n  log.category = category;\n\n  log.path = function relativePath(target: string | undefined | null): string | null {\n    try {\n      return target != null && path.isAbsolute(target)\n        ? path.relative(logPath, target).replace(/\\\\/, '/') || '.'\n        : (target ?? null);\n    } catch {\n      return target || null;\n    }\n  };\n\n  return log;\n}) as EventLoggerBuilder;\n\n// These are built-in events: We choose an ambiguous name on purpose,\n// since we don't assume this implementation will necessarily only be in `@expo/cli`\nexport const rootEvent = events('root', (t) => [t.event<'init', InitMetadata>()]);\n\nexport type { EventLogger } from './builder';\n"],"names":["events","installEventLogger","isEventLoggerActive","rootEvent","shouldReduceLogs","logPath","process","cwd","logStream","parseLogTarget","env","logDestination","fd","parseInt","Number","isSafeInteger","parsedPath","path","parse","format","dir","undefined","getInitMetadata","version","__EXPO_VERSION","LOG_EVENTS","eventLogDestination","output","WriteStream","Object","defineProperty","get","globalThis","console","Console","LogStream","writable","EXPO_UNSTABLE_HEADLESS","category","_fn","log","event","data","_e","String","_t","Date","now","payload","JSON","stringify","_write","relativePath","target","isAbsolute","relative","replace","t"],"mappings":";;;;;;;;;;;IAqGaA,MAAM;eAANA;;IAvDGC,kBAAkB;eAAlBA;;IAkBHC,mBAAmB;eAAnBA;;IAkEAC,SAAS;eAATA;;IA1DAC,gBAAgB;eAAhBA;;;;yBAxEW;;;;;;;gEACP;;;;;;;yBACW;;;;;;wBAGF;qBACN;;;;;;AAOpB,IAAIC,UAAUC,QAAQC,GAAG;AACzB,IAAIC;AAEJ,SAASC,eAAeC,GAAuB;IAC7C,IAAIC;IACJ,IAAID,KAAK;QACP,MAAME,KAAKC,SAASH,KAAK;QACzB,IAAIE,KAAK,KAAKE,OAAOC,aAAa,CAACH,KAAK;YACtCD,iBAAiBC;QACnB,OAAO;YACL,IAAI;gBACF,MAAMI,aAAaC,mBAAI,CAACC,KAAK,CAACR;gBAC9BC,iBAAiBM,mBAAI,CAACE,MAAM,CAACH;gBAC7BX,UAAUW,WAAWI,GAAG;YAC1B,EAAE,OAAM;gBACNT,iBAAiBU;YACnB;QACF;IACF;IACA,OAAOV;AACT;AAEA,SAASW;IACP,OAAO;QACLH,QAAQ;QACR,wCAAwC;QACxCI,SAASjB,QAAQI,GAAG,CAACc,cAAc,IAAI;IACzC;AACF;AAKO,SAASvB,mBAAmBS,MAAMJ,QAAQI,GAAG,CAACe,UAAU;IAC7D,MAAMC,sBAAsBjB,eAAeC;IAC3C,IAAIgB,qBAAqB;QACvB,IAAIA,wBAAwB,GAAG;YAC7B,MAAMC,SAAS,IAAIC,CAAAA,UAAU,aAAC,CAAC;YAC/BC,OAAOC,cAAc,CAACxB,SAAS,UAAU;gBAAEyB,KAAK,IAAMJ;YAAO;YAC7DK,WAAWC,OAAO,GAAG,IAAIC,CAAAA,cAAM,SAAC,CAACP,QAAQA;QAC3C,OAAO,IAAID,wBAAwB,GAAG;YACpC,MAAMC,SAAS,IAAIC,CAAAA,UAAU,aAAC,CAAC;YAC/BC,OAAOC,cAAc,CAACxB,SAAS,UAAU;gBAAEyB,KAAK,IAAMJ;YAAO;YAC7DK,WAAWC,OAAO,GAAG,IAAIC,CAAAA,cAAM,SAAC,CAACP,QAAQA;QAC3C;QACAnB,YAAY,IAAI2B,iBAAS,CAACT;QAC1BvB,UAAU,QAAQmB;IACpB;AACF;AAGO,MAAMpB,sBAAsB,IAAM,CAAC,EAACM,6BAAAA,UAAW4B,QAAQ;AAQvD,MAAMhC,mBAAmB,IAAM,CAAC,CAACI,aAAaE,QAAG,CAAC2B,sBAAsB;AA6BxE,MAAMrC,SAA8B,CACzCsC,UACAC;IAEA,SAASC,IAAIC,KAAa,EAAEC,IAAS;QACnC,IAAIlC,WAAW;YACb,MAAMmC,KAAK,GAAGL,SAAS,CAAC,EAAEM,OAAOH,QAAQ;YACzC,MAAMI,KAAKC,KAAKC,GAAG;YACnB,MAAMC,UAAUC,KAAKC,SAAS,CAAC;gBAAEP;gBAAIE;gBAAI,GAAGH,IAAI;YAAC;YACjDlC,UAAU2C,MAAM,CAACH,UAAU;QAC7B;IACF;IACAR,IAAIF,QAAQ,GAAGA;IAEfE,IAAIvB,IAAI,GAAG,SAASmC,aAAaC,MAAiC;QAChE,IAAI;YACF,OAAOA,UAAU,QAAQpC,mBAAI,CAACqC,UAAU,CAACD,UACrCpC,mBAAI,CAACsC,QAAQ,CAAClD,SAASgD,QAAQG,OAAO,CAAC,MAAM,QAAQ,MACpDH,UAAU;QACjB,EAAE,OAAM;YACN,OAAOA,UAAU;QACnB;IACF;IAEA,OAAOb;AACT;AAIO,MAAMrC,YAAYH,OAAO,QAAQ,CAACyD,IAAM;QAACA,EAAEhB,KAAK;KAAyB"}