{"version":3,"sources":["../../../src/events/stream.ts"],"sourcesContent":["import { Buffer } from 'node:buffer';\nimport { EventEmitter } from 'node:events';\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nconst BUSY_WRITE_TIMEOUT = 100;\nconst HIGH_WATER_MARK = 16_387; /*16KB*/\n\nexport class LogStream extends EventEmitter implements NodeJS.WritableStream {\n  #fd = -1;\n  #file: string | null = null;\n\n  #writing = false;\n  #ending = false;\n  #flushPending = false;\n  #destroyed = false;\n  #opening = false;\n\n  #output = '';\n  #len = 0;\n  #lines: string[] = [];\n  #partialLine = 0;\n\n  constructor(dest: string | number) {\n    super();\n    if (typeof dest === 'number') {\n      fs.fsyncSync(dest);\n      this.#fd = dest;\n      process.nextTick(() => this.emit('ready'));\n    } else if (typeof dest === 'string') {\n      this.#openFile(dest);\n    }\n  }\n\n  get file(): string | null {\n    return this.#file;\n  }\n\n  get fd(): number {\n    return this.#fd;\n  }\n\n  get writing(): boolean {\n    return this.#writing;\n  }\n\n  get writable(): boolean {\n    return !this.#destroyed && !this.#ending;\n  }\n\n  #release(error: NodeJS.ErrnoException | null, written: number) {\n    if (error) {\n      if (error.code === 'EAGAIN' || error.code === 'EBUSY') {\n        setTimeout(() => this.#writeLine(), BUSY_WRITE_TIMEOUT);\n      } else {\n        this.#writing = false;\n        this.emit('error', error);\n      }\n    } else {\n      this.emit('write', written);\n\n      const outputLength = Buffer.byteLength(this.#output);\n      if (outputLength > written) {\n        const output = Buffer.from(this.#output).subarray(written).toString();\n        this.#len -= this.#output.length - output.length;\n        this.#output = output;\n      } else {\n        this.#len -= this.#output.length;\n        this.#output = '';\n      }\n\n      if (this.#output || this.#lines.length > this.#partialLine) {\n        this.#writeLine();\n      } else if (this.#ending) {\n        this.#writing = false;\n        this.#close();\n      } else {\n        this.#writing = false;\n        this.emit('drain');\n      }\n    }\n  }\n\n  #openFile(file: string) {\n    this.#opening = true;\n    this.#writing = true;\n\n    const onOpened = (error: Error | null, fd?: number | null) => {\n      if (error) {\n        this.#writing = false;\n        this.#opening = false;\n        this.emit('error', error);\n      } else {\n        this.#fd = fd!;\n        this.#file = file;\n        this.#opening = false;\n        this.#writing = false;\n        this.emit('ready');\n        if (this.#destroyed) {\n          // do nothing when we're already closing the file\n        } else if (\n          (!this.writing && this.#lines.length > this.#partialLine) ||\n          this.#flushPending\n        ) {\n          this.#writeLine();\n        }\n      }\n    };\n\n    fs.mkdir(path.dirname(file), { recursive: true }, (err) => {\n      if (err) return onOpened(err);\n      fs.open(file, 'a', 0o666, onOpened);\n    });\n  }\n\n  #close() {\n    if (this.#fd === -1) {\n      this.once('ready', () => this.#close());\n      return;\n    }\n\n    this.#destroyed = true;\n    this.#partialLine = 0;\n    this.#lines.length = 0;\n\n    const onClose = (error?: NodeJS.ErrnoException | null) => {\n      if (error) {\n        this.emit('error', error);\n        this.emit('close', error);\n      } else {\n        if (this.#ending && !this.#writing) this.emit('finish');\n        this.emit('close');\n      }\n    };\n\n    fsFsync(this.#fd, (error) => {\n      if (!error && !isStdFd(this.#fd)) {\n        fs.close(this.#fd, onClose);\n      } else {\n        onClose(); // Error intentionally ignored, assume closed\n      }\n    });\n  }\n\n  #writeLine() {\n    this.#writing = true;\n    this.#output ||= this.#lines.length > this.#partialLine ? this.#lines.shift() || '' : '';\n    fs.write(this.#fd, this.#output, (err, written) => this.#release(err, written));\n  }\n\n  _end() {\n    if (!this.#destroyed && !this.#ending) {\n      this.#ending = true;\n      if (this.#opening) {\n        this.once('ready', () => this._end());\n      } else if (!this.#writing && this.#fd >= 0) {\n        if (this.#lines.length > this.#partialLine) {\n          this.#writeLine();\n        } else {\n          this.#close();\n        }\n      }\n    }\n    return this;\n  }\n\n  end(cb?: () => void): this;\n  end(data: string | Uint8Array, cb?: () => void): this;\n  end(str: string, encoding?: BufferEncoding, cb?: () => void): this;\n\n  end(\n    arg1?: Uint8Array | string | (() => void),\n    arg2?: BufferEncoding | (() => void),\n    arg3?: () => void\n  ) {\n    const maybeCb = arg3 || arg2 || arg1;\n    const input = typeof arg1 !== 'function' ? arg1 : undefined;\n    const encoding = typeof arg2 === 'string' ? arg2 : 'utf8';\n    const cb = typeof maybeCb === 'function' ? maybeCb : undefined;\n    if (typeof input === 'string') {\n      this.write(input, encoding);\n    } else if (input != null) {\n      this.write(input);\n    }\n    if (cb) this.once('close', cb);\n    return this._end();\n  }\n\n  destroy() {\n    if (!this.#destroyed) this.#close();\n  }\n\n  flush(cb?: (error?: Error | null) => void) {\n    if (this.#destroyed) {\n      cb?.();\n    } else {\n      const onDrain = () => {\n        if (!this.#destroyed) {\n          fsFsync(this.#fd, (error) => {\n            this.#flushPending = false;\n            if (error?.code === 'EBADF') {\n              cb?.(); // If fd is closed, ignore the error\n            } else {\n              cb?.(error);\n            }\n          });\n        } else {\n          this.#flushPending = false;\n          cb?.();\n        }\n        this.off('error', onError);\n      };\n\n      const onError = (err: Error) => {\n        this.#flushPending = false;\n        this.off('drain', onDrain);\n        cb?.(err);\n      };\n\n      this.#flushPending = true;\n      this.once('drain', onDrain);\n      this.once('error', onError);\n\n      if (!this.#writing) {\n        if (this.#lines.length > this.#partialLine || this.#output) {\n          // There are complete lines or remaining output to write\n          this.#writeLine();\n        } else {\n          // Nothing complete to write, emit drain immediately\n          process.nextTick(() => this.emit('drain'));\n        }\n      }\n    }\n  }\n\n  _write(data: string): boolean {\n    if (this.#destroyed) {\n      return false;\n    }\n\n    this.#len += data.length;\n\n    let startIdx = 0;\n    let endIdx = -1;\n    while ((endIdx = data.indexOf('\\n', startIdx)) > -1) {\n      const line = data.slice(startIdx, endIdx + 1);\n      if (this.#partialLine > 0) {\n        this.#lines[this.#lines.length - 1] += line;\n      } else {\n        this.#lines.push(line);\n      }\n      this.#partialLine = 0;\n      startIdx = ++endIdx;\n    }\n\n    if (startIdx < data.length) {\n      const line = data.slice(startIdx);\n      if (this.#partialLine > 0) {\n        this.#lines[this.#lines.length - 1] += line;\n      } else {\n        this.#lines.push(data.slice(startIdx));\n      }\n      this.#partialLine = 1;\n    }\n\n    if (!this.#writing && this.#lines.length > this.#partialLine) {\n      this.#writeLine();\n    }\n\n    return this.#len < HIGH_WATER_MARK;\n  }\n\n  write(buffer: Uint8Array | string, cb?: (err?: Error | null) => void): boolean;\n  write(str: string, encoding?: BufferEncoding, cb?: (err?: Error | null) => void): boolean;\n\n  write(\n    input: Uint8Array | string,\n    arg2?: BufferEncoding | ((err?: Error | null) => void),\n    arg3?: (err?: Error | null) => void\n  ): boolean {\n    const maybeCb = arg3 || arg2;\n    const encoding = typeof arg2 === 'string' ? arg2 : 'utf8';\n    const data = typeof input === 'string' ? input : Buffer.from(input).toString(encoding);\n    const cb = typeof maybeCb === 'function' ? maybeCb : undefined;\n    try {\n      return this._write(data);\n    } finally {\n      cb?.();\n    }\n  }\n\n  [Symbol.dispose]() {\n    this.destroy();\n  }\n}\n\nconst isStdFd = (fd: number) => {\n  switch (fd) {\n    case 1:\n    case 2:\n    case process.stdout.fd:\n    case process.stderr.fd:\n      return true;\n    default:\n      return false;\n  }\n};\n\nconst fsFsync = (fd: number, cb: (error?: NodeJS.ErrnoException | null) => void) => {\n  try {\n    fs.fsync(fd, cb);\n  } catch (error: any) {\n    cb(error);\n  }\n};\n"],"names":["LogStream","BUSY_WRITE_TIMEOUT","HIGH_WATER_MARK","EventEmitter","constructor","dest","fs","fsyncSync","process","nextTick","emit","file","fd","writing","writable","error","written","code","setTimeout","outputLength","Buffer","byteLength","output","from","subarray","toString","length","onOpened","mkdir","path","dirname","recursive","err","open","once","onClose","fsFsync","isStdFd","close","shift","write","_end","end","arg1","arg2","arg3","maybeCb","input","undefined","encoding","cb","destroy","flush","onDrain","off","onError","_write","data","startIdx","endIdx","indexOf","line","slice","push","Symbol","dispose","stdout","stderr","fsync"],"mappings":"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"}